<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Turnos del Médico</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4F46E5',
            secondary: '#06B6D4',
            success: '#10B981',
            danger: '#EF4444',
            warning: '#F59E0B'
          }
        }
      }
    };
  </script>
</head>
<body class="bg-gray-50 text-gray-800 p-6">
  <h1 class="text-3xl font-bold text-center text-primary mb-6">Turnos asignados</h1>

  <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
    <input id="filtro-dni" type="text" placeholder="Filtrar por DNI" class="border border-gray-300 rounded-md p-2 w-full md:w-1/4"/>
    <input id="filtro-apellido" type="text" placeholder="Filtrar por Apellido" class="border border-gray-300 rounded-md p-2 w-full md:w-1/4"/>
    <input id="filtro-fecha" type="date" class="border border-gray-300 rounded-md p-2 w-full md:w-1/4"/>
    <select id="filtro-semana" class="border border-gray-300 rounded-md p-2 w-full md:w-1/4">
      <option value="">Filtrar por semana</option>
      <option value="1">Semana 1 (1–7)</option>
      <option value="2">Semana 2 (8–14)</option>
      <option value="3">Semana 3 (15–21)</option>
      <option value="4">Semana 4 (22–28)</option>
      <option value="5">Semana 5 (29–31)</option>
    </select>
    <div class="flex gap-2">
      <button onclick="filtrarPorFecha()" class="bg-secondary text-white px-4 py-2 rounded-md">Filtrar por Fecha</button>
      <button onclick="cargarTurnos()" class="bg-gray-300 text-black px-4 py-2 rounded-md">Limpiar Filtros</button>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
    <div>
      <h2 class="text-lg font-semibold text-gray-700 mb-2">Sin Atender</h2>
      <div id="sin-atender" class="space-y-2"></div>
    </div>
    <div>
      <h2 class="text-lg font-semibold text-gray-700 mb-2">Llamado</h2>
      <div id="llamado" class="space-y-2"></div>
    </div>
    <div>
      <h2 class="text-lg font-semibold text-gray-700 mb-2">Atendido</h2>
      <div id="atendido" class="space-y-2"></div>
    </div>
    <div>
      <h2 class="text-lg font-semibold text-gray-700 mb-2">Ausente</h2>
      <div id="ausente" class="space-y-2"></div>
    </div>
  </div>

  <a href="/" class="mt-10 block text-center text-primary font-semibold hover:underline">&larr; Volver al inicio</a>

  <script>
    let pacientes = [];
    let rolUsuario = null;

    async function cargarPacientes() {
      const res = await fetch("/api/pacientes");
      pacientes = await res.json();
    }

    async function obtenerRol() {
      const res = await fetch("/api/session-info");
      const data = await res.json();
      rolUsuario = data.rol;
    }

    function formatearFechaHora(fecha, hora) {
      if (!fecha || !hora) return "-";
      const [y, m, d] = fecha.split("-");
      return `${d}/${m}/${y} - ${hora}`;
    }

    function obtenerSemanaDelMes(fechaStr) {
      const [y, m, d] = fechaStr.split("-").map(Number);
      if (!d) return null;
      if (d >= 1 && d <= 7) return 1;
      if (d >= 8 && d <= 14) return 2;
      if (d >= 15 && d <= 21) return 3;
      if (d >= 22 && d <= 28) return 4;
      return 5;
    }

    async function cargarTurnos(filtroExtra = () => true) {
      await obtenerRol();

      const dniFiltro = document.getElementById("filtro-dni").value.trim();
      const apellidoFiltro = document.getElementById("filtro-apellido").value.trim().toLowerCase();
      const semanaFiltro = document.getElementById("filtro-semana").value;

      const turnos = await fetch('/api/turnos/medico').then(r => r.json());

      const estados = {
        "sin atender": document.getElementById("sin-atender"),
        "llamado": document.getElementById("llamado"),
        "atendido": document.getElementById("atendido"),
        "ausente": document.getElementById("ausente")
      };

      Object.values(estados).forEach(div => div.innerHTML = "");

      turnos
        .filter(t =>
          (!dniFiltro || t.dni_paciente === dniFiltro) &&
          (!apellidoFiltro || (pacientes.find(p => p.dni === t.dni_paciente)?.apellido?.toLowerCase().includes(apellidoFiltro))) &&
          filtroExtra(t) &&
          (!semanaFiltro || obtenerSemanaDelMes(t.fecha) === parseInt(semanaFiltro))
        )
        .forEach(t => {
          const paciente = pacientes.find(p => p.dni === t.dni_paciente) || {};
          const estado = t.estado || "sin atender";

          const div = document.createElement("div");
          div.className = "border border-gray-200 p-4 rounded-lg shadow bg-white";
          div.innerHTML = `
            <p class="font-semibold text-lg">${paciente.nombre || ""} ${paciente.apellido || ""}</p>
            <p class="text-sm text-gray-600">DNI: ${t.dni_paciente}</p>
            <p class="text-sm text-gray-600">Fecha: ${formatearFechaHora(t.fecha, t.hora)}</p>
            <p class="text-sm font-medium text-gray-500 uppercase mb-1">Estado: <span class="capitalize">${estado}</span></p>
            ${rolUsuario === 'medico' ? `
              <div class="mt-3 space-x-2">
                <button onclick='actualizarEstado(${JSON.stringify(t)}, "llamado")' class="bg-warning text-white px-3 py-1 rounded hover:bg-yellow-500">Llamar</button>
                <button onclick='actualizarEstado(${JSON.stringify(t)}, "atendido")' class="bg-success text-white px-3 py-1 rounded hover:bg-green-600">Atendido</button>
                <button onclick='actualizarEstado(${JSON.stringify(t)}, "ausente")' class="bg-danger text-white px-3 py-1 rounded hover:bg-red-600">Ausente</button>
              </div>` : ""}
          `;
          estados[estado]?.appendChild(div);
        });
    }

    async function actualizarEstado(turno, estado) {
      await fetch('/api/turnos/estado', {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          dni_paciente: turno.dni_paciente,
          fecha: turno.fecha,
          hora: turno.hora,
          estado: estado
        })
      });

      if (estado === "atendido") {
        window.location.href = `/historias?dni=${turno.dni_paciente}`;
      } else {
        cargarTurnos();
      }
    }

    function filtrarPorFecha() {
      const fechaSeleccionada = document.getElementById("filtro-fecha").value;
      if (!fechaSeleccionada) return;
      cargarTurnos(t => t.fecha === fechaSeleccionada);
    }

    async function iniciarPagina() {
      await cargarPacientes();
      await cargarTurnos();
    }

    iniciarPagina();
  </script>
</body>
</html>



