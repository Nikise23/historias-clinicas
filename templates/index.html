<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de Historias Clínicas</title>
  <style>
    body { font-family: Arial; margin: 30px; background: #f2f2f2; }
    input, textarea, button { width: 100%; margin-bottom: 10px; padding: 8px; }
    .historia { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background: white; }
    .boton { margin-right: 5px; }
  </style>
</head>
<body>
  <h1>Gestión de Historias Clínicas</h1>

  <h2 id="form-titulo">Crear Historia Clínica</h2>
  <form id="formulario">
    <input type="text" id="nombre" placeholder="Nombre completo" required>
    <input type="text" id="dni" placeholder="DNI" required>
    <input type="date" id="fecha_nacimiento" placeholder="Fecha de nacimiento">
    <input type="date" id="fecha_consulta" placeholder="Fecha de consulta">
    <input type="text" id="diagnostico" placeholder="Diagnóstico" required>
    <input type="text" id="tratamiento" placeholder="Tratamiento">
    <textarea id="observaciones" placeholder="Observaciones"></textarea>
    <input type="text" id="medico" placeholder="Médico" required>
    <button type="submit" id="btn-guardar">Guardar</button>
  </form>

  <h3>Buscar por DNI</h3>
  <input type="text" id="dni_buscar" placeholder="Ingrese DNI">
  <button onclick="buscarHistoria()">Buscar</button>

  <h3>Ver Todas</h3>
  <button onclick="cargarHistorias()">Cargar Historias</button>
  <div id="resultado"></div>

  <script>
    let modoEdicion = false;
    let idEditando = null;

    document.getElementById("formulario").addEventListener("submit", function(e) {
      e.preventDefault();
      const datos = {
        nombre: nombre.value.trim(),
        dni: dni.value.trim(),
        fecha_nacimiento: fecha_nacimiento.value,
        fecha_consulta: fecha_consulta.value,
        diagnostico: diagnostico.value.trim(),
        tratamiento: tratamiento.value.trim(),
        observaciones: observaciones.value.trim(),
        medico: medico.value.trim()
      };

      if (!datos.nombre || !datos.dni || !datos.diagnostico || !datos.medico) {
        alert("Completa los campos obligatorios");
        return;
      }

      const url = modoEdicion ? `/historias/${idEditando}` : "/historias";
      const metodo = modoEdicion ? "PUT" : "POST";

      fetch(url, {
        method: metodo,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos)
      })
      .then(r => r.json())
      .then(res => {
        alert(res.mensaje || res.error);
        formulario.reset();
        modoEdicion = false;
        idEditando = null;
        document.getElementById("btn-guardar").textContent = "Guardar";
        document.getElementById("form-titulo").textContent = "Crear Historia Clínica";
        cargarHistorias();
      });
    });

    function cargarHistorias() {
  fetch("/historias")
    .then(r => r.json())
    .then(data => {
      resultado.innerHTML = "";
      data.forEach(h => {
        const div = document.createElement("div");
        div.className = "historia";
        div.innerHTML = `
          <strong>${h.nombre}</strong> (DNI: ${h.dni})<br>
          Fecha Nac: ${h.fecha_nacimiento} - Consulta: ${h.fecha_consulta}<br>
          Diagnóstico: ${h.diagnostico}<br>
          Tratamiento: ${h.tratamiento}<br>
          Observaciones: ${h.observaciones}<br>
          Médico: ${h.medico}<br>
          <button class="boton" onclick='editarHistoria(${JSON.stringify(h)})'>Modificar</button>
          <button class="boton" onclick="eliminarHistoria('${h.dni}')">Eliminar</button>
        `;
        resultado.appendChild(div);
      });
    });
}

function buscarHistoria() {
  const dni = dni_buscar.value.trim();
  if (!dni) return alert("Ingrese un DNI");

  fetch(`/historias/${dni}`)
    .then(r => {
      if (!r.ok) throw new Error("Historia no encontrada");
      return r.json();
    })
    .then(h => {
      resultado.innerHTML = "";
      const div = document.createElement("div");
      div.className = "historia";
      div.innerHTML = `
        <strong>${h.nombre}</strong> (DNI: ${h.dni})<br>
        Fecha Nac: ${h.fecha_nacimiento} - Consulta: ${h.fecha_consulta}<br>
        Diagnóstico: ${h.diagnostico}<br>
        Tratamiento: ${h.tratamiento}<br>
        Observaciones: ${h.observaciones}<br>
        Médico: ${h.medico}<br>
        <button class="boton" onclick='editarHistoria(${JSON.stringify(h)})'>Modificar</button>
        <button class="boton" onclick="eliminarHistoria('${h.dni}')">Eliminar</button>
      `;
      resultado.appendChild(div);
    })
    .catch(() => alert("Historia no encontrada"));
}

function eliminarHistoria(dni) {
  if (!confirm("¿Eliminar esta historia?")) return;
  fetch(`/historias/${dni}`, { method: "DELETE" })
    .then(r => r.json())
    .then(res => {
      alert(res.mensaje || res.error);
      cargarHistorias();
    });
}

function editarHistoria(h) {
  nombre.value = h.nombre;
  dni.value = h.dni;
  fecha_nacimiento.value = h.fecha_nacimiento;
  fecha_consulta.value = h.fecha_consulta;
  diagnostico.value = h.diagnostico;
  tratamiento.value = h.tratamiento;
  observaciones.value = h.observaciones;
  medico.value = h.medico;
  modoEdicion = true;
  idEditando = h.dni;
  dni.disabled = true;  // Bloqueamos edición del DNI para evitar problemas
  document.getElementById("btn-guardar").textContent = "Guardar cambios";
  document.getElementById("form-titulo").textContent = "Modificar Historia Clínica";
}

  </script>
</body>
</html>
