<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel Principal ‚Äë Cl√≠nica</title>


  <!-- Bootstrap & Icons -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">


  <style>
    body{
      background:#f4f6f9;
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      padding:20px;min-height:100vh;display:flex;flex-direction:column
    }
    h1,h3,h4{color:#2c3e50}
    .card-panel{background:#fff;border-radius:16px;box-shadow:0 6px 12px rgb(0 0 0 / .05);padding:25px;margin-bottom:30px}
    #logout-btn{background:#dc3545;color:#fff;font-weight:600;transition:.3s}
    #logout-btn:hover{background:#bb2d3b}
    #info-usuario{font-weight:600;color:#2c3e50;margin-left:auto;white-space:nowrap}
    .btn-action{width:100%;text-align:left;font-weight:600;font-size:1rem;padding:15px 20px;border-radius:12px;transition:.3s}
    .btn-action i{margin-right:12px;font-size:1.25rem}
    .btn-outline-primary.btn-action:hover{background:#0d6efd;color:#fff!important}
    .btn-outline-success.btn-action:hover{background:#198754;color:#fff!important}
    .btn-outline-info.btn-action:hover{background:#0dcaf0;color:#fff!important}
    @media(max-width:600px){
      #logout-btn,#info-usuario{float:none;width:100%;text-align:center;margin-bottom:10px}
    }
    /*‚ÄäResumen */
    #resumen-medico ul{max-width:400px;margin:0 auto}
    #resumen-medico li{font-size:1.05rem;font-weight:600}
    /*‚ÄäTarjetas de historias */
    #resultado .card-panel{border-radius:12px;box-shadow:0 3px 8px rgb(0 0 0 /.08);padding:18px;margin-bottom:18px;transition:.2s}
    #resultado .card-panel:hover{box-shadow:0 6px 16px rgb(0 0 0 /.15)}
  </style>
</head>
<body>
  <!-- Encabezado -->
  <div class="d-flex flex-wrap align-items-center mb-4 gap-3">
    <h1>Bienvenido/a <span id="info-usuario"></span></h1>
    <button id="logout-btn" class="btn btn-sm ms-auto"
            onclick="location.href='/logout'">
      <i class="bi bi-box-arrow-right"></i> Cerrar sesi√≥n
    </button>
  </div>


  <!-- Acciones -->
  <div class="card-panel" id="contenedor-botones">
    
     <!-- Secretaria -->
    <div id="botones-secretaria"
         class="row row-cols-1 row-cols-md-2 g-3" style="display:none">
      <div class="col">
        <a href="/agenda" class="btn btn-outline-primary btn-action">
          
          <i class="bi bi-calendar-week"></i> Administrar Agenda
        </a>
      </div>
      <div class="col">
        <a href="/pacientes" class="btn btn-outline-success btn-action">
          
           <i class="bi bi-person-plus"></i> Registrar Pacientes
        </a>
      </div>
      <div class="col">
        <a href="/turnos" class="btn btn-outline-info btn-action">
          <i class="bi bi-clipboard2-check"></i> Gestionar Turnos
        </a>
      </div>
      <div class="col">
        <a href="/secretaria" class="btn btn-outline-warning btn-action">
          <i class="bi bi-speedometer2"></i> Panel Secretar√≠a
        </a>
      </div>
    </div>
          <!-- M√©dico -->
    <div id="botones-medico"
         class="row row-cols-1 row-cols-md-3 g-3" style="display:none">
      <div class="col">
        <a href="/turnos" class="btn btn-outline-info btn-action">
          <i class="bi bi-clipboard-check"></i> Gesti√≥n de Pacientes
        </a>
      </div>
      <div class="col">
        <a href="#" onclick="mostrarMiAgenda()" class="btn btn-outline-primary btn-action">
          <i class="bi bi-calendar-week"></i> Ver Mi Agenda
        </a>
      </div>
      <div class="col">
        <button onclick="abrirModalHistoriaClinica()" class="btn btn-outline-success btn-action">
          <i class="bi bi-file-medical"></i> Crear Historia Cl√≠nica
        </button>
      </div>
    </div>
  </div>

  <!-- Dashboard del M√©dico -->
  <div class="card-panel" id="dashboard-medico" style="display:none">
    
    <!-- Estad√≠sticas R√°pidas -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card bg-primary text-white">
          <div class="card-body text-center">
            <i class="bi bi-clock-history fs-2"></i>
            <h4 id="turnos-pendientes" class="mt-2">0</h4>
            <small>Pendientes Hoy</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-warning text-dark">
          <div class="card-body text-center">
            <i class="bi bi-people-fill fs-2"></i>
            <h4 id="en-sala-espera" class="mt-2">0</h4>
            <small>En Sala de Espera</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-success text-white">
          <div class="card-body text-center">
            <i class="bi bi-check-circle-fill fs-2"></i>
            <h4 id="pacientes-atendidos" class="mt-2">0</h4>
            <small>Atendidos Hoy</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-info text-white">
          <div class="card-body text-center">
            <i class="bi bi-calendar-week fs-2"></i>
            <h4 id="total-turnos-hoy" class="mt-2">0</h4>
            <small>Total Turnos Hoy</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Selector de Fecha para Agenda -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5><i class="bi bi-calendar3"></i> Mi Agenda</h5>
          <button class="btn btn-sm btn-outline-primary" onclick="toggleAgenda()" id="toggle-agenda-btn">
            <i class="bi bi-eye"></i> Mostrar Agenda
          </button>
        </div>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
          <input type="date" id="fecha-agenda-medico" class="form-control" onchange="cargarAgendaMedico()">
          <button class="btn btn-outline-secondary" onclick="cargarAgendaHoy()">Hoy</button>
        </div>
      </div>
      <div class="col-md-6">
        <h5><i class="bi bi-clock"></i> Pr√≥ximos Turnos</h5>
        <div id="proximos-turnos" class="small"></div>
      </div>
    </div>
    
    <!-- Agenda del D√≠a (Colapsible) -->
    <div id="agenda-medico-container" style="display: none;">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0"><i class="bi bi-calendar-day"></i> Agenda del D√≠a</h6>
        </div>
        <div class="card-body" id="agenda-content">
          <h6 class="text-muted">Selecciona una fecha para ver tu agenda</h6>
        </div>
      </div>
    </div>


  <!-- Buscador de historias (solo m√©dico) -->
  <div class="card-panel" id="busqueda-pacientes" style="display:none">
    <div class="card">
      <div class="card-header bg-info text-white">
        <h4 class="mb-0"><i class="bi bi-search"></i> Buscar Historia Cl√≠nica</h4>
      </div>
      <div class="card-body">
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-person-badge"></i></span>
              <input id="dni_buscar" class="form-control" placeholder="Buscar por DNI" type="number">
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-person"></i></span>
              <input id="apellido_buscar" class="form-control" placeholder="Buscar por Apellido">
            </div>
          </div>
        </div>
        <div class="d-flex flex-wrap gap-2 mb-3">
          <button class="btn btn-primary" onclick="buscarPorDNI()">
            <i class="bi bi-search"></i> Buscar por DNI
          </button>
          <button class="btn btn-primary" onclick="buscarPorApellido()">
            <i class="bi bi-search"></i> Buscar por Apellido
          </button>
          <button class="btn btn-success" onclick="cargarHistorias()">
            <i class="bi bi-list-ul"></i> Cargar todas
          </button>
          <button class="btn btn-warning" onclick="limpiarBusqueda()">
            <i class="bi bi-arrow-clockwise"></i> Limpiar
          </button>
        </div>
        
        <!-- Estad√≠sticas de b√∫squeda -->
        <div class="row mb-3" id="estadisticas-busqueda" style="display: none;">
          <div class="col-md-4">
            <div class="card bg-primary text-white text-center">
              <div class="card-body">
                <h5 id="total-resultados">0</h5>
                <small>Resultados encontrados</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card bg-success text-white text-center">
              <div class="card-body">
                <h5 id="pacientes-unicos">0</h5>
                <small>Pacientes √∫nicos</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card bg-info text-white text-center">
              <div class="card-body">
                <button class="btn btn-light btn-sm" onclick="descargarResultadosPDF()">
                  <i class="bi bi-download"></i> Descargar PDF
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Resultados de historias -->
  <div id="resultado"></div>


  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


  <script>
    /* === Cargar info de sesi√≥n === */
    fetch("/api/session-info")
      .then(r=>r.json())
      .then(({usuario,rol})=>{
        if(!usuario||!rol) return;
        document.getElementById("info-usuario").textContent=`${usuario} | ${rol.toUpperCase()}`;


        if(rol==="secretaria"){
          document.getElementById("botones-secretaria").style.display="flex";
        }else if(rol==="medico"){
          document.getElementById("botones-medico").style.display="flex";
          document.getElementById("busqueda-pacientes").style.display="block";
          document.getElementById("dashboard-medico").style.display="block";
          cargarDashboardMedico();          // <- nuevo dashboard mejorado
        }
      });


    /* === Dashboard del M√©dico === */
    let usuarioMedico = null;
    let historiasResultado = []; // Para almacenar resultados de b√∫squeda
    
    function cargarDashboardMedico(){
      // Establecer fecha de hoy por defecto
      const hoy = new Date().toISOString().slice(0, 10);
      document.getElementById("fecha-agenda-medico").value = hoy;
      
      // Cargar estad√≠sticas del d√≠a
      cargarEstadisticasMedico();
      
      // Cargar agenda de hoy
      cargarAgendaMedico();
      
      // Cargar pr√≥ximos turnos
      cargarProximosTurnos();
    }
    
    function cargarEstadisticasMedico(){
      const hoy = new Date().toISOString().slice(0, 10);
      fetch("/api/turnos/medico")
        .then(r => r.json())
        .then(turnos => {
          const turnosHoy = turnos.filter(t => t.fecha === hoy);
          
          const pendientes = turnosHoy.filter(t => ["sin atender", "recepcionado"].includes(t.estado)).length;
          const enSala = turnosHoy.filter(t => ["sala de espera", "llamado"].includes(t.estado)).length;
          const atendidos = turnosHoy.filter(t => t.estado === "atendido").length;
          const total = turnosHoy.length;
          
          document.getElementById("turnos-pendientes").textContent = pendientes;
          document.getElementById("en-sala-espera").textContent = enSala;
          document.getElementById("pacientes-atendidos").textContent = atendidos;
          document.getElementById("total-turnos-hoy").textContent = total;
        })
        .catch(console.error);
    }
    function cargarAgendaHoy(){
      const hoy = new Date().toISOString().slice(0, 10);
      document.getElementById("fecha-agenda-medico").value = hoy;
      cargarAgendaMedico();
    }
    
    function cargarAgendaMedico(){
      const fechaSeleccionada = document.getElementById("fecha-agenda-medico").value;
      if (!fechaSeleccionada) return;
      
      const container = document.getElementById("agenda-content");
      
      // Obtener informaci√≥n del usuario si no la tenemos
      if (!usuarioMedico) {
        fetch("/api/session-info")
          .then(r => r.json())
          .then(({usuario}) => {
            usuarioMedico = usuario;
            renderizarAgendaMedico(fechaSeleccionada, container);
          });
      } else {
        renderizarAgendaMedico(fechaSeleccionada, container);
      }
    }

    function renderizarAgendaMedico(fecha, container){
      Promise.all([
        fetch("/api/agenda"),
        fetch(`/api/turnos/dia?fecha=${fecha}`)
      ])
      .then(([agendaRes, turnosRes]) => Promise.all([agendaRes.json(), turnosRes.json()]))
      .then(([agenda, turnos]) => {
        const fechaObj = new Date(fecha + 'T12:00:00');
        const diasSemana = ["DOMINGO", "LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES", "SABADO"];
        const diaSeleccionado = diasSemana[fechaObj.getDay()];
        
        // Filtrar turnos del m√©dico
        const turnosMedico = turnos.filter(t => t.medico === usuarioMedico);
        
        // Obtener horarios configurados para este m√©dico en este d√≠a
        const horariosConfigurados = agenda[usuarioMedico]?.[diaSeleccionado] || [];
        
        if (horariosConfigurados.length === 0) {
          container.innerHTML = `
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> 
              No tienes horarios configurados para ${diaSeleccionado.toLowerCase()} (${new Date(fecha).toLocaleDateString('es-ES')})
            </div>
          `;
          return;
        }
        
        let html = `
          <h6><i class="bi bi-calendar-day"></i> ${diaSeleccionado} - ${new Date(fecha).toLocaleDateString('es-ES')}</h6>
          <div class="row">
        `;
        horariosConfigurados.forEach(hora => {
          const turno = turnosMedico.find(t => t.hora === hora);
          
          if (turno) {
            // Horario ocupado
            const paciente = turno.paciente || {};
            const nombrePaciente = `${paciente.nombre || ''} ${paciente.apellido || ''}`.trim() || `DNI: ${turno.dni_paciente}`;
            const estadoColor = {
              'sin atender': 'warning',
              'recepcionado': 'info',
              'sala de espera': 'primary',
              'llamado': 'secondary',
              'atendido': 'success',
              'ausente': 'danger'
            }[turno.estado] || 'secondary';
            
            const estadoEmoji = {
              'sin atender': '‚è≥',
              'recepcionado': 'üìã',
              'sala de espera': 'ü™ë',
              'llamado': 'üì¢',
              'atendido': '‚úÖ',
              'ausente': '‚ùå'
            }[turno.estado] || '‚è≥';
            
            html += `
              <div class="col-md-4 mb-3">
                <div class="card border-${estadoColor}">
                  <div class="card-body text-center">
                    <h6 class="card-title">${hora}</h6>
                    <div class="text-${estadoColor} mb-2">${estadoEmoji}</div>
                    <p class="card-text small">
                      <strong>${nombrePaciente}</strong><br>
                      <span class="badge bg-${estadoColor}">${turno.estado}</span>
                    </p>
                  </div>
                </div>
              </div>
            `;
          } else {
            // Horario libre
            html += `
              <div class="col-md-4 mb-3">
                <div class="card border-light bg-light">
                  <div class="card-body text-center">
                    <h6 class="card-title">${hora}</h6>
                    <div class="text-muted mb-2">‚≠ï</div>
                    <p class="card-text small text-muted">
                      <em>Libre</em>
                    </p>
                  </div>
                </div>
              </div>
            `;
          }
        });
        
        html += '</div>';
        container.innerHTML = html;
      })
      .catch(error => {
        container.innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> 
            Error al cargar la agenda: ${error.message}
          </div>
        `;
      });
    }

    function cargarProximosTurnos(){
      fetch("/api/turnos/medico")
        .then(r => r.json())
        .then(turnos => {
          const ahora = new Date();
          const proximosTurnos = turnos
            .filter(t => {
              const fechaTurno = new Date(`${t.fecha}T${t.hora}`);
              return fechaTurno > ahora && ['sin atender', 'recepcionado', 'sala de espera'].includes(t.estado);
            })
            .sort((a, b) => new Date(`${a.fecha}T${a.hora}`) - new Date(`${b.fecha}T${b.hora}`))
            .slice(0, 3);
            
          const container = document.getElementById("proximos-turnos");
          
          if (proximosTurnos.length === 0) {
            container.innerHTML = '<em class="text-muted">No hay turnos pr√≥ximos</em>';
            
            return;
          }
          let html = '';
          proximosTurnos.forEach(t => {
            const paciente = t.paciente || {};
            const nombrePaciente = `${paciente.nombre || ''} ${paciente.apellido || ''}`.trim() || `DNI: ${t.dni_paciente}`;
            html += `
              <div class="border-bottom pb-1 mb-1">
                <strong>${t.fecha} ${t.hora}</strong><br>
                <span class="text-muted">${nombrePaciente}</span>
              </div>
            `;
          });
          
          container.innerHTML = html;
        })
        .catch(() => {
          document.getElementById("proximos-turnos").innerHTML = '<em class="text-muted">Error al cargar pr√≥ximos turnos</em>';
        });
    }
    
    function toggleAgenda(){
      const container = document.getElementById("agenda-medico-container");
      const btn = document.getElementById("toggle-agenda-btn");
      const icon = btn.querySelector("i");
      const text = btn.textContent.trim();
      
      if (container.style.display === "none") {
        // Mostrar agenda
        container.style.display = "block";
        icon.className = "bi bi-eye-slash";
        btn.innerHTML = '<i class="bi bi-eye-slash"></i> Ocultar Agenda';
        btn.className = "btn btn-sm btn-outline-secondary";
        
        // Cargar agenda si hay fecha seleccionada
        const fechaActual = document.getElementById("fecha-agenda-medico").value;
        if (fechaActual) {
          cargarAgendaMedico();
        } else {
          cargarAgendaHoy();
        }
      } else {
        // Ocultar agenda
        container.style.display = "none";
        icon.className = "bi bi-eye";
        btn.innerHTML = '<i class="bi bi-eye"></i> Mostrar Agenda';
        btn.className = "btn btn-sm btn-outline-primary";
      }
    }

    function mostrarMiAgenda(){
      // Mostrar agenda si est√° oculta
      const container = document.getElementById("agenda-medico-container");
      if (container.style.display === "none") {
        toggleAgenda();
      }
      
      const fechaActual = document.getElementById("fecha-agenda-medico").value;
      if (fechaActual) {
        cargarAgendaMedico();
      } else {
        cargarAgendaHoy();
      }
      
      // Hacer scroll suave hacia la agenda
      document.getElementById("agenda-medico-container").scrollIntoView({ 
        behavior: 'smooth' 
      });
    }

    /* === Historias cl√≠nicas === */
    function mostrarHistorias(lista){
      historiasResultado = lista; // Guardar resultados para PDF
      const res = document.getElementById("resultado");
      res.innerHTML = "";
      
      // Mostrar estad√≠sticas
      const estadisticas = document.getElementById("estadisticas-busqueda");
      if (lista.length > 0) {
        const pacientesUnicos = new Set(lista.map(h => h.dni)).size;
        document.getElementById("total-resultados").textContent = lista.length;
        document.getElementById("pacientes-unicos").textContent = pacientesUnicos;
        estadisticas.style.display = "block";
      } else {
        estadisticas.style.display = "none";
        res.innerHTML = `
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            No se encontraron historias cl√≠nicas.
          </div>
        `;
        return;
      }
      
      // Crear contenedor con t√≠tulo
      const contenedor = document.createElement("div");
      contenedor.className = "card";
      contenedor.innerHTML = `
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="bi bi-file-medical"></i> 
            Resultados de B√∫squeda (${lista.length} historias encontradas)
          </h5>
        </div>
        <div class="card-body">
          <div class="row" id="historias-container"></div>
        </div>
      `;
      res.appendChild(contenedor);
      
      const historiasContainer = document.getElementById("historias-container");
      
      // Cargar datos de pacientes para enriquecer las historias
      fetch("/api/pacientes")
        .then(r => r.json())
        .then(pacientes => {
          lista.forEach((h, index) => {
            // Buscar datos del paciente
            const paciente = pacientes.find(p => p.dni === h.dni);
            const nombreCompleto = paciente ? `${paciente.nombre} ${paciente.apellido}`.trim() : 'Paciente no encontrado';
            const fechaNac = paciente?.fecha_nacimiento ? new Date(paciente.fecha_nacimiento).toLocaleDateString('es-ES') : 'No especificada';
            const edad = paciente?.edad ? `${paciente.edad} a√±os` : 'No especificada';
            const telefono = paciente?.celular || 'No especificado';
            
            const fecha = h.fecha_consulta ? new Date(h.fecha_consulta).toLocaleDateString('es-ES') : 'No especificada';
            
            const card = document.createElement("div");
            card.className = "col-md-6 col-lg-4 mb-3";
            card.innerHTML = `
              <div class="card h-100 border-primary">
                <div class="card-header bg-primary text-white">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                      <i class="bi bi-person-circle"></i> 
                      ${nombreCompleto}
                    </h6>
                    <button class="btn btn-sm btn-light" onclick="descargarHistoriaIndividual(${index})" title="Descargar PDF">
                      <i class="bi bi-download"></i>
                    </button>
                  </div>
                </div>
                <div class="card-body">
                  <div class="row mb-2">
                    <div class="col-6">
                      <small class="text-muted">DNI:</small><br>
                      <strong>${h.dni}</strong>
                    </div>
                    <div class="col-6">
                      <small class="text-muted">Edad:</small><br>
                      <strong>${edad}</strong>
                    </div>
                  </div>
                  
                  <div class="row mb-2">
                    <div class="col-6">
                      <small class="text-muted">Fecha Nac:</small><br>
                      <strong>${fechaNac}</strong>
                    </div>
                    <div class="col-6">
                      <small class="text-muted">Tel√©fono:</small><br>
                      <strong>${telefono}</strong>
                    </div>
                  </div>
                  
                  <div class="row mb-2">
                    <div class="col-12">
                      <small class="text-muted">Fecha Consulta:</small><br>
                      <strong>${fecha}</strong>
                    </div>
                  </div>
                  
                  ${h.diagnostico ? `
                    <div class="mb-2">
                      <small class="text-muted">Diagn√≥stico:</small><br>
                      <strong>${h.diagnostico}</strong>
                    </div>
                  ` : ''}
                  
                  ${h.tratamiento ? `
                    <div class="mb-2">
                      <small class="text-muted">Tratamiento:</small><br>
                      <strong>${h.tratamiento}</strong>
                    </div>
                  ` : ''}
                  
                  ${h.observaciones ? `
                    <div class="mb-2">
                      <small class="text-muted">Observaciones:</small><br>
                      <em>${h.observaciones}</em>
                    </div>
                  ` : ''}
                  
                  ${h.consulta_medica ? `
                    <div class="mb-2">
                      <small class="text-muted">Consulta M√©dica:</small><br>
                      <em>${h.consulta_medica.substring(0, 100)}${h.consulta_medica.length > 100 ? '...' : ''}</em>
                    </div>
                  ` : ''}
                  
                  <div class="mt-2">
                    <small class="text-muted">M√©dico:</small><br>
                    <strong>${h.medico || 'No especificado'}</strong>
                  </div>
                </div>
                <div class="card-footer">
                  <button class="btn btn-sm btn-outline-primary" onclick="verHistoriaCompleta('${h.dni}')">
                    <i class="bi bi-eye"></i> Ver Completa
                  </button>
                </div>
              </div>
            `;
            historiasContainer.appendChild(card);
          });
        })
        .catch(error => {
          console.error("Error al cargar datos de pacientes:", error);
          // Mostrar historias sin datos de pacientes si hay error
          lista.forEach((h, index) => {
            const fecha = h.fecha_consulta ? new Date(h.fecha_consulta).toLocaleDateString('es-ES') : 'No especificada';
            
            const card = document.createElement("div");
            card.className = "col-md-6 col-lg-4 mb-3";
            card.innerHTML = `
              <div class="card h-100 border-warning">
                <div class="card-header bg-warning text-dark">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                      <i class="bi bi-exclamation-triangle"></i> 
                      DNI: ${h.dni}
                    </h6>
                    <button class="btn btn-sm btn-dark" onclick="descargarHistoriaIndividual(${index})" title="Descargar PDF">
                      <i class="bi bi-download"></i>
                    </button>
                  </div>
                </div>
                <div class="card-body">
                  <div class="alert alert-warning">
                    <small>No se pudieron cargar los datos del paciente</small>
                  </div>
                  
                  <div class="mb-2">
                    <small class="text-muted">Fecha Consulta:</small><br>
                    <strong>${fecha}</strong>
                  </div>
                  
                  ${h.diagnostico ? `
                    <div class="mb-2">
                      <small class="text-muted">Diagn√≥stico:</small><br>
                      <strong>${h.diagnostico}</strong>
                    </div>
                  ` : ''}
                  
                  ${h.tratamiento ? `
                    <div class="mb-2">
                      <small class="text-muted">Tratamiento:</small><br>
                      <strong>${h.tratamiento}</strong>
                    </div>
                  ` : ''}
                  
                  ${h.observaciones ? `
                    <div class="mb-2">
                      <small class="text-muted">Observaciones:</small><br>
                      <em>${h.observaciones}</em>
                    </div>
                  ` : ''}
                  
                  ${h.consulta_medica ? `
                    <div class="mb-2">
                      <small class="text-muted">Consulta M√©dica:</small><br>
                      <em>${h.consulta_medica.substring(0, 100)}${h.consulta_medica.length > 100 ? '...' : ''}</em>
                    </div>
                  ` : ''}
                  
                  <div class="mt-2">
                    <small class="text-muted">M√©dico:</small><br>
                    <strong>${h.medico || 'No especificado'}</strong>
                  </div>
                </div>
                <div class="card-footer">
                  <button class="btn btn-sm btn-outline-warning" onclick="verHistoriaCompleta('${h.dni}')">
                    <i class="bi bi-eye"></i> Ver Completa
                  </button>
                </div>
              </div>
            `;
            historiasContainer.appendChild(card);
          });
        });
    }


    function cargarHistorias(){
      fetch("/api/historias")
        .then(r=>r.json())
        .then(mostrarHistorias)
        .catch(()=>alert("Error al cargar historias"));
    }


    function buscarPorDNI(){
      const dni=document.getElementById("dni_buscar").value.trim();
      if(!dni) return alert("Ingrese un DNI");
      fetch(`/historias/${dni}`)
        .then(r=>r.json())
        .then(h=> h.error ? alert("Historia no encontrada")
                          : mostrarHistorias([h]));
    }


    function buscarPorApellido(){
      const ape=document.getElementById("apellido_buscar").value.trim().toLowerCase();
      if(!ape) return alert("Ingrese un apellido");
      fetch("/historias")
        .then(r=>r.json())
        .then(all=>{
          const filtradas=all.filter(h=>h.nombre.toLowerCase().split(" ").some(p=>p.startsWith(ape)));
          filtradas.length ? mostrarHistorias(filtradas)
                           : alert("No se encontraron coincidencias");
        });
    }

    function limpiarBusqueda(){
      document.getElementById("dni_buscar").value = "";
      document.getElementById("apellido_buscar").value = "";
      document.getElementById("resultado").innerHTML = "";
      document.getElementById("estadisticas-busqueda").style.display = "none";
      historiasResultado = [];
    }

    function verHistoriaCompleta(dni){
      window.location.href = `/historias?dni=${dni}`;
    }

    function descargarHistoriaIndividual(index){
      const historia = historiasResultado[index];
      if (!historia) return;

      // Obtener datos del paciente
      fetch("/api/pacientes")
        .then(r => r.json())
        .then(pacientes => {
          const paciente = pacientes.find(p => p.dni === historia.dni);
          const nombreCompleto = paciente ? `${paciente.nombre} ${paciente.apellido}`.trim() : 'Paciente no encontrado';
          const fechaNac = paciente?.fecha_nacimiento ? new Date(paciente.fecha_nacimiento).toLocaleDateString('es-ES') : 'No especificada';
          const edad = paciente?.edad ? `${paciente.edad} a√±os` : 'No especificada';
          const telefono = paciente?.celular || 'No especificado';
          const obraSocial = paciente?.obra_social || 'No especificada';

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          
          // Configurar fuente y tama√±os
          doc.setFont("helvetica");
          doc.setFontSize(20);
          doc.text("Historia Cl√≠nica", 105, 20, { align: "center" });
          
          doc.setFontSize(12);
          doc.text("Datos del Paciente:", 20, 40);
          doc.setFontSize(10);
          doc.text(`Nombre: ${nombreCompleto}`, 20, 50);
          doc.text(`DNI: ${historia.dni}`, 20, 60);
          doc.text(`Edad: ${edad}`, 20, 70);
          doc.text(`Fecha de Nacimiento: ${fechaNac}`, 20, 80);
          doc.text(`Tel√©fono: ${telefono}`, 20, 90);
          doc.text(`Obra Social: ${obraSocial}`, 20, 100);
          
          doc.setFontSize(12);
          doc.text("Datos de la Consulta:", 20, 120);
          doc.setFontSize(10);
          
          const fecha = historia.fecha_consulta ? new Date(historia.fecha_consulta).toLocaleDateString('es-ES') : 'No especificada';
          doc.text(`Fecha de Consulta: ${fecha}`, 20, 130);
          doc.text(`M√©dico: ${historia.medico || 'No especificado'}`, 20, 140);
          
          let yPosition = 160;
          
          if (historia.diagnostico) {
            doc.setFontSize(12);
            doc.text("Diagn√≥stico:", 20, yPosition);
            yPosition += 5;
            doc.setFontSize(10);
            const dxLines = doc.splitTextToSize(historia.diagnostico, 170);
            doc.text(dxLines, 20, yPosition);
            yPosition += dxLines.length * 5 + 5;
          }
          
          if (historia.tratamiento) {
            doc.setFontSize(12);
            doc.text("Tratamiento:", 20, yPosition);
            yPosition += 5;
            doc.setFontSize(10);
            const txLines = doc.splitTextToSize(historia.tratamiento, 170);
            doc.text(txLines, 20, yPosition);
            yPosition += txLines.length * 5 + 5;
          }
          
          if (historia.observaciones) {
            doc.setFontSize(12);
            doc.text("Observaciones:", 20, yPosition);
            yPosition += 5;
            doc.setFontSize(10);
            const obsLines = doc.splitTextToSize(historia.observaciones, 170);
            doc.text(obsLines, 20, yPosition);
            yPosition += obsLines.length * 5 + 5;
          }
          
          if (historia.consulta_medica) {
            doc.setFontSize(12);
            doc.text("Consulta M√©dica:", 20, yPosition);
            yPosition += 5;
            doc.setFontSize(10);
            const consultaLines = doc.splitTextToSize(historia.consulta_medica, 170);
            doc.text(consultaLines, 20, yPosition);
          }
          
          // Guardar PDF
          const fileName = `historia_${historia.dni}_${fecha.replace(/\//g, '-')}.pdf`;
          doc.save(fileName);
        })
        .catch(error => {
          console.error("Error al obtener datos del paciente:", error);
          // Generar PDF sin datos del paciente si hay error
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          
          doc.setFont("helvetica");
          doc.setFontSize(20);
          doc.text("Historia Cl√≠nica", 105, 20, { align: "center" });
          
          doc.setFontSize(12);
          doc.text("Datos del Paciente:", 20, 40);
          doc.setFontSize(10);
          doc.text(`DNI: ${historia.dni}`, 20, 50);
          doc.text(`Nombre: No disponible`, 20, 60);
          
          doc.setFontSize(12);
          doc.text("Datos de la Consulta:", 20, 80);
          doc.setFontSize(10);
          
          const fecha = historia.fecha_consulta ? new Date(historia.fecha_consulta).toLocaleDateString('es-ES') : 'No especificada';
          doc.text(`Fecha de Consulta: ${fecha}`, 20, 90);
          doc.text(`M√©dico: ${historia.medico || 'No especificado'}`, 20, 100);
          
          let yPosition = 120;
          
          if (historia.diagnostico) {
            doc.setFontSize(12);
            doc.text("Diagn√≥stico:", 20, yPosition);
            yPosition += 5;
            doc.setFontSize(10);
            const dxLines = doc.splitTextToSize(historia.diagnostico, 170);
            doc.text(dxLines, 20, yPosition);
            yPosition += dxLines.length * 5 + 5;
          }
          
          if (historia.tratamiento) {
            doc.setFontSize(12);
            doc.text("Tratamiento:", 20, yPosition);
            yPosition += 5;
            doc.setFontSize(10);
            const txLines = doc.splitTextToSize(historia.tratamiento, 170);
            doc.text(txLines, 20, yPosition);
            yPosition += txLines.length * 5 + 5;
          }
          
          if (historia.observaciones) {
            doc.setFontSize(12);
            doc.text("Observaciones:", 20, yPosition);
            yPosition += 5;
            doc.setFontSize(10);
            const obsLines = doc.splitTextToSize(historia.observaciones, 170);
            doc.text(obsLines, 20, yPosition);
            yPosition += obsLines.length * 5 + 5;
          }
          
          if (historia.consulta_medica) {
            doc.setFontSize(12);
            doc.text("Consulta M√©dica:", 20, yPosition);
            yPosition += 5;
            doc.setFontSize(10);
            const consultaLines = doc.splitTextToSize(historia.consulta_medica, 170);
            doc.text(consultaLines, 20, yPosition);
          }
          
          const fileName = `historia_${historia.dni}_${fecha.replace(/\//g, '-')}.pdf`;
          doc.save(fileName);
        });
    }

    function descargarResultadosPDF(){
      if (historiasResultado.length === 0) {
        alert("No hay resultados para descargar");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // T√≠tulo
      doc.setFont("helvetica");
      doc.setFontSize(20);
      doc.text("Reporte de Historias Cl√≠nicas", 105, 20, { align: "center" });
      
      doc.setFontSize(10);
      doc.text(`Fecha de generaci√≥n: ${new Date().toLocaleDateString('es-ES')}`, 20, 30);
      doc.text(`Total de historias: ${historiasResultado.length}`, 20, 40);
      doc.text(`Pacientes √∫nicos: ${new Set(historiasResultado.map(h => h.dni)).size}`, 20, 50);
      
      // Historial de consultas
      let yPosition = 70;
      doc.setFontSize(14);
      doc.text("Historias Cl√≠nicas:", 20, yPosition);
      yPosition += 10;
      
      historiasResultado.forEach((historia, index) => {
        if (yPosition > 250) {
          doc.addPage();
          yPosition = 20;
        }
        
        const fecha = historia.fecha_consulta ? new Date(historia.fecha_consulta).toLocaleDateString('es-ES') : 'No especificada';
        doc.setFontSize(12);
        doc.text(`${index + 1}. ${historia.nombre || 'Sin nombre'} (DNI: ${historia.dni}) - ${fecha}`, 20, yPosition);
        yPosition += 5;
        doc.setFontSize(10);
        doc.text(`M√©dico: ${historia.medico || 'No especificado'}`, 20, yPosition);
        yPosition += 5;
        
        if (historia.diagnostico) {
          doc.text(`Diagn√≥stico: ${historia.diagnostico}`, 20, yPosition);
          yPosition += 5;
        }
        
        if (historia.tratamiento) {
          doc.text(`Tratamiento: ${historia.tratamiento}`, 20, yPosition);
          yPosition += 5;
        }
        
        yPosition += 5; // Espacio entre historias
      });
      
      // Guardar PDF
      const fileName = `reporte_historias_${new Date().toISOString().split('T')[0]}.pdf`;
      doc.save(fileName);
    }

    /* === Modal para crear historia cl√≠nica === */
    function abrirModalHistoriaClinica() {
      const dni = prompt("Ingrese el DNI del paciente para crear la historia cl√≠nica:");
      if (dni && dni.trim()) {
        window.location.href = `/historias?dni=${dni.trim()}`;
      }
    }
  </script>
</body>
</html>
