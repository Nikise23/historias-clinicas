<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel Principal ‚Äë Cl√≠nica</title>


  <!-- Bootstrap & Icons -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">


  <style>
    body{
      background:#f4f6f9;
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      padding:20px;min-height:100vh;display:flex;flex-direction:column
    }
    h1,h3,h4{color:#2c3e50}
    .card-panel{background:#fff;border-radius:16px;box-shadow:0 6px 12px rgb(0 0 0 / .05);padding:25px;margin-bottom:30px}
    #logout-btn{background:#dc3545;color:#fff;font-weight:600;transition:.3s}
    #logout-btn:hover{background:#bb2d3b}
    #info-usuario{font-weight:600;color:#2c3e50;margin-left:auto;white-space:nowrap}
    .btn-action{width:100%;text-align:left;font-weight:600;font-size:1rem;padding:15px 20px;border-radius:12px;transition:.3s}
    .btn-action i{margin-right:12px;font-size:1.25rem}
    .btn-outline-primary.btn-action:hover{background:#0d6efd;color:#fff!important}
    .btn-outline-success.btn-action:hover{background:#198754;color:#fff!important}
    .btn-outline-info.btn-action:hover{background:#0dcaf0;color:#fff!important}
    @media(max-width:600px){
      #logout-btn,#info-usuario{float:none;width:100%;text-align:center;margin-bottom:10px}
    }
    /*‚ÄäResumen */
    #resumen-medico ul{max-width:400px;margin:0 auto}
    #resumen-medico li{font-size:1.05rem;font-weight:600}
    /*‚ÄäTarjetas de historias */
    #resultado .card-panel{border-radius:12px;box-shadow:0 3px 8px rgb(0 0 0 /.08);padding:18px;margin-bottom:18px;transition:.2s}
    #resultado .card-panel:hover{box-shadow:0 6px 16px rgb(0 0 0 /.15)}
  </style>
</head>
<body>
  <!-- Encabezado -->
  <div class="d-flex flex-wrap align-items-center mb-4 gap-3">
    <h1>Bienvenido/a <span id="info-usuario"></span></h1>
    <button id="logout-btn" class="btn btn-sm ms-auto"
            onclick="location.href='/logout'">
      <i class="bi bi-box-arrow-right"></i> Cerrar sesi√≥n
    </button>
  </div>


  <!-- Acciones -->
  <div class="card-panel" id="contenedor-botones">
    
     <!-- Secretaria -->
    <div id="botones-secretaria"
         class="row row-cols-1 row-cols-md-2 g-3" style="display:none">
      <div class="col">
        <a href="/agenda" class="btn btn-outline-primary btn-action">
          
          <i class="bi bi-calendar-week"></i> Administrar Agenda
        </a>
      </div>
      <div class="col">
        <a href="/pacientes" class="btn btn-outline-success btn-action">
          
           <i class="bi bi-person-plus"></i> Registrar Pacientes
        </a>
      </div>
      <div class="col">
        <a href="/turnos" class="btn btn-outline-info btn-action">
          <i class="bi bi-clipboard2-check"></i> Gestionar Turnos
        </a>
      </div>
      <div class="col">
        <a href="/secretaria" class="btn btn-outline-warning btn-action">
          <i class="bi bi-speedometer2"></i> Panel Secretar√≠a
        </a>
      </div>
    </div>
          <!-- M√©dico -->
    <div id="botones-medico"
         class="row row-cols-1 row-cols-md-3 g-3" style="display:none">
      <div class="col">
        <a href="/turnos" class="btn btn-outline-info btn-action">
          <i class="bi bi-clipboard-check"></i> Gesti√≥n de Pacientes
        </a>
      </div>
      <div class="col">
        <a href="#" onclick="mostrarMiAgenda()" class="btn btn-outline-primary btn-action">
          <i class="bi bi-calendar-week"></i> Ver Mi Agenda
        </a>
      </div>
      <div class="col">
        <a href="/historias?dni=" class="btn btn-outline-success btn-action">
          <i class="bi bi-file-medical"></i> Crear Historia Cl√≠nica
        </a>
      </div>
    </div>
  </div>

  <!-- Dashboard del M√©dico -->
  <div class="card-panel" id="dashboard-medico" style="display:none">
    
    <!-- Estad√≠sticas R√°pidas -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card bg-primary text-white">
          <div class="card-body text-center">
            <i class="bi bi-clock-history fs-2"></i>
            <h4 id="turnos-pendientes" class="mt-2">0</h4>
            <small>Pendientes Hoy</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-warning text-dark">
          <div class="card-body text-center">
            <i class="bi bi-people-fill fs-2"></i>
            <h4 id="en-sala-espera" class="mt-2">0</h4>
            <small>En Sala de Espera</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-success text-white">
          <div class="card-body text-center">
            <i class="bi bi-check-circle-fill fs-2"></i>
            <h4 id="pacientes-atendidos" class="mt-2">0</h4>
            <small>Atendidos Hoy</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-info text-white">
          <div class="card-body text-center">
            <i class="bi bi-calendar-week fs-2"></i>
            <h4 id="total-turnos-hoy" class="mt-2">0</h4>
            <small>Total Turnos Hoy</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Selector de Fecha para Agenda -->
    <div class="row mb-4">
      <div class="col-md-6">
        <h5><i class="bi bi-calendar3"></i> Mi Agenda</h5>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
          <input type="date" id="fecha-agenda-medico" class="form-control" onchange="cargarAgendaMedico()">
          <button class="btn btn-outline-secondary" onclick="cargarAgendaHoy()">Hoy</button>
        </div>
      </div>
      <div class="col-md-6">
        <h5><i class="bi bi-clock"></i> Pr√≥ximos Turnos</h5>
        <div id="proximos-turnos" class="small"></div>
      </div>
    
    </div>
    <!-- Agenda del D√≠a -->
    <div id="agenda-medico-container">
      <h6 class="text-muted">Selecciona una fecha para ver tu agenda</h6>
    </div>


  <!-- Buscador de historias (solo m√©dico) -->
  <div class="card-panel" id="busqueda-pacientes" style="display:none">
    <h3>Buscar Historia Cl√≠nica</h3>
    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <input id="dni_buscar" class="form-control" placeholder="Buscar por DNI">
      </div>
      <div class="col-md-6">
        <input id="apellido_buscar" class="form-control" placeholder="Buscar por Apellido">
      </div>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <button class="btn btn-secondary" onclick="buscarPorDNI()">Buscar por DNI</button>
      <button class="btn btn-secondary" onclick="buscarPorApellido()">Buscar por Apellido</button>
      <button class="btn btn-secondary" onclick="cargarHistorias()">Cargar todas</button>
    </div>
  </div>


  <!-- Resultados de historias -->
  <div id="resultado"></div>


  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


  <script>
    /* === Cargar info de sesi√≥n === */
    fetch("/api/session-info")
      .then(r=>r.json())
      .then(({usuario,rol})=>{
        if(!usuario||!rol) return;
        document.getElementById("info-usuario").textContent=`${usuario} | ${rol.toUpperCase()}`;


        if(rol==="secretaria"){
          document.getElementById("botones-secretaria").style.display="flex";
        }else if(rol==="medico"){
          document.getElementById("botones-medico").style.display="flex";
          document.getElementById("busqueda-pacientes").style.display="block";
          document.getElementById("dashboard-medico").style.display="block";
          cargarDashboardMedico();          // <- nuevo dashboard mejorado
        }
      });


    /* === Dashboard del M√©dico === */
    let usuarioMedico = null;
    
    function cargarDashboardMedico(){
      // Establecer fecha de hoy por defecto
      const hoy = new Date().toISOString().slice(0, 10);
      document.getElementById("fecha-agenda-medico").value = hoy;
      
      // Cargar estad√≠sticas del d√≠a
      cargarEstadisticasMedico();
      
      // Cargar agenda de hoy
      cargarAgendaMedico();
      
      // Cargar pr√≥ximos turnos
      cargarProximosTurnos();
    }
    
    function cargarEstadisticasMedico(){
      const hoy = new Date().toISOString().slice(0, 10);
      fetch("/api/turnos/medico")
        .then(r => r.json())
        .then(turnos => {
          const turnosHoy = turnos.filter(t => t.fecha === hoy);
          
          const pendientes = turnosHoy.filter(t => ["sin atender", "recepcionado"].includes(t.estado)).length;
          const enSala = turnosHoy.filter(t => ["sala de espera", "llamado"].includes(t.estado)).length;
          const atendidos = turnosHoy.filter(t => t.estado === "atendido").length;
          const total = turnosHoy.length;
          
          document.getElementById("turnos-pendientes").textContent = pendientes;
          document.getElementById("en-sala-espera").textContent = enSala;
          document.getElementById("pacientes-atendidos").textContent = atendidos;
          document.getElementById("total-turnos-hoy").textContent = total;
        })
        .catch(console.error);
    }
    function cargarAgendaHoy(){
      const hoy = new Date().toISOString().slice(0, 10);
      document.getElementById("fecha-agenda-medico").value = hoy;
      cargarAgendaMedico();
    }
    
    function cargarAgendaMedico(){
      const fechaSeleccionada = document.getElementById("fecha-agenda-medico").value;
      if (!fechaSeleccionada) return;
      
      const container = document.getElementById("agenda-medico-container");
      
      // Obtener informaci√≥n del usuario si no la tenemos
      if (!usuarioMedico) {
        fetch("/api/session-info")
          .then(r => r.json())
          .then(({usuario}) => {
            usuarioMedico = usuario;
            renderizarAgendaMedico(fechaSeleccionada, container);
          });
      } else {
        renderizarAgendaMedico(fechaSeleccionada, container);
      }
    }

    function renderizarAgendaMedico(fecha, container){
      Promise.all([
        fetch("/api/agenda"),
        fetch(`/api/turnos/dia?fecha=${fecha}`)
      ])
      .then(([agendaRes, turnosRes]) => Promise.all([agendaRes.json(), turnosRes.json()]))
      .then(([agenda, turnos]) => {
        const fechaObj = new Date(fecha + 'T12:00:00');
        const diasSemana = ["DOMINGO", "LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES", "SABADO"];
        const diaSeleccionado = diasSemana[fechaObj.getDay()];
        
        // Filtrar turnos del m√©dico
        const turnosMedico = turnos.filter(t => t.medico === usuarioMedico);
        
        // Obtener horarios configurados para este m√©dico en este d√≠a
        const horariosConfigurados = agenda[usuarioMedico]?.[diaSeleccionado] || [];
        
        if (horariosConfigurados.length === 0) {
          container.innerHTML = `
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> 
              No tienes horarios configurados para ${diaSeleccionado.toLowerCase()} (${new Date(fecha).toLocaleDateString('es-ES')})
            </div>
          `;
          return;
        }
        
        let html = `
          <h6><i class="bi bi-calendar-day"></i> ${diaSeleccionado} - ${new Date(fecha).toLocaleDateString('es-ES')}</h6>
          <div class="row">
        `;
        horariosConfigurados.forEach(hora => {
          const turno = turnosMedico.find(t => t.hora === hora);
          
          if (turno) {
            // Horario ocupado
            const paciente = turno.paciente || {};
            const nombrePaciente = `${paciente.nombre || ''} ${paciente.apellido || ''}`.trim() || `DNI: ${turno.dni_paciente}`;
            const estadoColor = {
              'sin atender': 'warning',
              'recepcionado': 'info',
              'sala de espera': 'primary',
              'llamado': 'secondary',
              'atendido': 'success',
              'ausente': 'danger'
            }[turno.estado] || 'secondary';
            
            const estadoEmoji = {
              'sin atender': '‚è≥',
              'recepcionado': 'üìã',
              'sala de espera': 'ü™ë',
              'llamado': 'üì¢',
              'atendido': '‚úÖ',
              'ausente': '‚ùå'
            }[turno.estado] || '‚è≥';
            
            html += `
              <div class="col-md-4 mb-3">
                <div class="card border-${estadoColor}">
                  <div class="card-body text-center">
                    <h6 class="card-title">${hora}</h6>
                    <div class="text-${estadoColor} mb-2">${estadoEmoji}</div>
                    <p class="card-text small">
                      <strong>${nombrePaciente}</strong><br>
                      <span class="badge bg-${estadoColor}">${turno.estado}</span>
                    </p>
                  </div>
                </div>
              </div>
            `;
          } else {
            // Horario libre
            html += `
              <div class="col-md-4 mb-3">
                <div class="card border-light bg-light">
                  <div class="card-body text-center">
                    <h6 class="card-title">${hora}</h6>
                    <div class="text-muted mb-2">‚≠ï</div>
                    <p class="card-text small text-muted">
                      <em>Libre</em>
                    </p>
                  </div>
                </div>
              </div>
            `;
          }
        });
        
        html += '</div>';
        container.innerHTML = html;
      })
      .catch(error => {
        container.innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> 
            Error al cargar la agenda: ${error.message}
          </div>
        `;
      });
    }

    function cargarProximosTurnos(){
      fetch("/api/turnos/medico")
        .then(r => r.json())
        .then(turnos => {
          const ahora = new Date();
          const proximosTurnos = turnos
            .filter(t => {
              const fechaTurno = new Date(`${t.fecha}T${t.hora}`);
              return fechaTurno > ahora && ['sin atender', 'recepcionado', 'sala de espera'].includes(t.estado);
            })
            .sort((a, b) => new Date(`${a.fecha}T${a.hora}`) - new Date(`${b.fecha}T${b.hora}`))
            .slice(0, 3);
            
          const container = document.getElementById("proximos-turnos");
          
          if (proximosTurnos.length === 0) {
            container.innerHTML = '<em class="text-muted">No hay turnos pr√≥ximos</em>';
            
            return;
          }
          let html = '';
          proximosTurnos.forEach(t => {
            const paciente = t.paciente || {};
            const nombrePaciente = `${paciente.nombre || ''} ${paciente.apellido || ''}`.trim() || `DNI: ${t.dni_paciente}`;
            html += `
              <div class="border-bottom pb-1 mb-1">
                <strong>${t.fecha} ${t.hora}</strong><br>
                <span class="text-muted">${nombrePaciente}</span>
              </div>
            `;
          });
          
          container.innerHTML = html;
        })
        .catch(() => {
          document.getElementById("proximos-turnos").innerHTML = '<em class="text-muted">Error al cargar pr√≥ximos turnos</em>';
        });
    }
    
    function mostrarMiAgenda(){
      const fechaActual = document.getElementById("fecha-agenda-medico").value;
      if (fechaActual) {
        cargarAgendaMedico();
      } else {
        cargarAgendaHoy();
      }
      
      // Hacer scroll suave hacia la agenda
      document.getElementById("agenda-medico-container").scrollIntoView({ 
        behavior: 'smooth' 
      });

    }

    /* === Historias cl√≠nicas === */
    function mostrarHistorias(lista){
      const res=document.getElementById("resultado");
      res.innerHTML="";
      if(!lista.length){
        res.innerHTML="<div class='alert alert-warning'>No se encontraron historias cl√≠nicas.</div>";
        return;
      }
      lista.forEach(h=>{
        const card=document.createElement("div");
        card.className="card-panel";
        card.innerHTML=`
          <strong>${h.nombre}</strong> (DNI ${h.dni})<br>
          Nac: ${h.fecha_nacimiento||"-"} | Consulta: ${h.fecha_consulta||"-"}<br>
          <em>Dx:</em> ${h.diagnostico}<br>
          <em>Tx:</em> ${h.tratamiento||"-"}<br>
          Obs: ${h.observaciones||"-"}<br>
          M√©dico: ${h.medico}`;
        res.appendChild(card);
      });
    }


    function cargarHistorias(){
      fetch("/api/historias")
        .then(r=>r.json())
        .then(mostrarHistorias)
        .catch(()=>alert("Error al cargar historias"));
    }


    function buscarPorDNI(){
      const dni=document.getElementById("dni_buscar").value.trim();
      if(!dni) return alert("Ingrese un DNI");
      fetch(`/historias/${dni}`)
        .then(r=>r.json())
        .then(h=> h.error ? alert("Historia no encontrada")
                          : mostrarHistorias([h]));
    }


    function buscarPorApellido(){
      const ape=document.getElementById("apellido_buscar").value.trim().toLowerCase();
      if(!ape) return alert("Ingrese un apellido");
      fetch("/historias")
        .then(r=>r.json())
        .then(all=>{
          const filtradas=all.filter(h=>h.nombre.toLowerCase().split(" ").some(p=>p.startsWith(ape)));
          filtradas.length ? mostrarHistorias(filtradas)
                           : alert("No se encontraron coincidencias");
        });
    }
  </script>
</body>
</html>
