<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Secretaría - Clínica</title>
  
  <!-- Bootstrap & Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .dashboard-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      padding: 2rem;
      margin: 2rem;
    }
    
    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border-left: 4px solid;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }
    
    .stat-card.patients { border-left-color: #28a745; }
    .stat-card.appointments { border-left-color: #007bff; }
    .stat-card.today { border-left-color: #ffc107; }
    .stat-card.pending { border-left-color: #dc3545; }
    
    .action-btn {
      background: linear-gradient(45deg, #667eea, #764ba2);
      border: none;
      border-radius: 15px;
      padding: 1rem 1.5rem;
      color: white;
      font-weight: 600;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      transition: all 0.3s ease;
      margin: 0.5rem;
    }
    
    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      color: white;
    }
    
    .action-btn i {
      margin-right: 0.5rem;
      font-size: 1.2rem;
    }
    
    .quick-search {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      margin-bottom: 2rem;
    }
    
    .table-container {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      margin-top: 2rem;
    }
    
    .title-section {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .title-section h1 {
      color: #2c3e50;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .title-section p {
      color: #6c757d;
      font-size: 1.1rem;
    }
    
    .btn-custom {
      border-radius: 10px;
      padding: 0.5rem 1rem;
      font-weight: 600;
      border: none;
      transition: all 0.3s ease;
    }
    
    .btn-custom:hover {
      transform: translateY(-1px);
    }
  </style>
</head>

<body>
  <div class="container-fluid">
    <div class="dashboard-container">
      
      <!-- Header -->
      <div class="title-section">
        <h1><i class="bi bi-clipboard2-data"></i> Panel de Secretaría</h1>
        <p>Gestión completa de pacientes, turnos y agenda médica</p>
      </div>
      
      <!-- Statistics Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="stat-card patients">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-1">Total Pacientes</h6>
                <h3 class="mb-0" id="total-pacientes">0</h3>
              </div>
              <i class="bi bi-people-fill fs-1 text-success opacity-50"></i>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="stat-card appointments">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-1">Turnos Totales</h6>
                <h3 class="mb-0" id="total-turnos">0</h3>
              </div>
              <i class="bi bi-calendar-check-fill fs-1 text-primary opacity-50"></i>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="stat-card today">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-1">Turnos Hoy</h6>
                <h3 class="mb-0" id="turnos-hoy">0</h3>
              </div>
              <i class="bi bi-calendar-day-fill fs-1 text-warning opacity-50"></i>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="stat-card pending">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-1">Pendientes</h6>
                <h3 class="mb-0" id="turnos-pendientes">0</h3>
              </div>
              <i class="bi bi-clock-fill fs-1 text-danger opacity-50"></i>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Finance Statistics -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="stat-card" style="border-left-color: #28a745;">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-1">Ingresos del Día</h6>
                <h3 class="mb-0" id="total-dia">$0</h3>
              </div>
              <i class="bi bi-cash-coin fs-1 text-success opacity-50"></i>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="stat-card" style="border-left-color: #007bff;">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-1">Ingresos del Mes</h6>
                <h3 class="mb-0" id="total-mes">$0</h3>
              </div>
              <i class="bi bi-calendar-month fs-1 text-primary opacity-50"></i>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="text-center">
            <a href="/pacientes" class="action-btn">
              <i class="bi bi-person-plus"></i> Registrar Pacientes
            </a>
            <a href="/turnos" class="action-btn">
              <i class="bi bi-clipboard2-check"></i> Gestionar Turnos
            </a>
            <a href="/agenda" class="action-btn">
              <i class="bi bi-calendar-week"></i> Administrar Agenda
            </a>
            <button class="action-btn" onclick="mostrarBusquedaAvanzada()">
              <i class="bi bi-search"></i> Búsqueda Avanzada
            </button>
            <button class="action-btn" onclick="mostrarGestionPagos()">
              <i class="bi bi-cash-stack"></i> Gestión de Pagos
            </button>
          </div>
        </div>
      </div>
      
      <!-- Quick Search -->
      <div class="quick-search" id="busqueda-rapida">
        <h5 class="mb-3"><i class="bi bi-search"></i> Búsqueda Rápida</h5>
        <div class="row">
          <div class="col-md-4">
            <input type="text" id="buscar-paciente" class="form-control" placeholder="Buscar paciente por nombre o DNI">
          </div>
          <div class="col-md-4">
            <input type="date" id="buscar-fecha" class="form-control">
          </div>
          <div class="col-md-4">
            <div class="d-flex gap-2">
              <button class="btn btn-primary btn-custom" onclick="buscarPaciente()">
                <i class="bi bi-search"></i> Buscar
              </button>
              <button class="btn btn-secondary btn-custom" onclick="limpiarBusqueda()">
                <i class="bi bi-arrow-clockwise"></i> Limpiar
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Advanced Search (Hidden by default) -->
      <div class="quick-search" id="busqueda-avanzada" style="display: none;">
        <h5 class="mb-3"><i class="bi bi-funnel"></i> Búsqueda Avanzada</h5>
        <div class="row">
          <div class="col-md-3">
            <select id="filtro-medico" class="form-select">
              <option value="">Todos los médicos</option>
            </select>
          </div>
          <div class="col-md-3">
            <select id="filtro-estado" class="form-select">
              <option value="">Todos los estados</option>
              <option value="sin atender">Sin atender</option>
              <option value="llamado">Llamado</option>
              <option value="atendido">Atendido</option>
              <option value="ausente">Ausente</option>
            </select>
          </div>
          <div class="col-md-3">
            <input type="text" id="filtro-obra-social" class="form-control" placeholder="Obra social">
          </div>
          <div class="col-md-3">
            <button class="btn btn-success btn-custom w-100" onclick="aplicarFiltrosAvanzados()">
              <i class="bi bi-funnel-fill"></i> Aplicar Filtros
            </button>
          </div>
        </div>
      </div>
      
      <!-- Payment Management Section -->
      <div class="quick-search" id="gestion-pagos" style="display: none;">
        <h5 class="mb-3"><i class="bi bi-cash-stack"></i> Gestión de Pagos</h5>
        
        <!-- Payment Statistics and Export -->
        <div class="row mb-3">
          <div class="col-md-6">
            <input type="date" id="fecha-pagos" class="form-control" value="">
          </div>
          <div class="col-md-6">
            <div class="d-flex gap-2">
              <button class="btn btn-success btn-custom" onclick="cargarPacientesAtendidos()">
                <i class="bi bi-person-check"></i> Ver Atendidos
              </button>
              <button class="btn btn-info btn-custom" onclick="exportarPagosCSV()">
                <i class="bi bi-download"></i> Exportar CSV
              </button>
            </div>
          </div>
        </div>
        
        <!-- Patients to Pay -->
        <div id="pacientes-pagar" style="display: none;">
          <h6 class="mb-2">Pacientes Atendidos Pendientes de Pago</h6>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead class="table-light">
                <tr>
                  <th>Apellido</th>
                  <th>Nombre</th>
                  <th>DNI</th>
                  <th>Hora</th>
                  <th>Médico</th>
                  <th>Monto</th>
                  <th>Acción</th>
                </tr>
              </thead>
              <tbody id="tabla-pacientes-pagar">
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Payment History -->
        <div id="historial-pagos">
          <h6 class="mb-2">Pagos Registrados Hoy</h6>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead class="table-light">
                <tr>
                  <th>Apellido</th>
                  <th>Nombre</th>
                  <th>DNI</th>
                  <th>Monto</th>
                  <th>Observaciones</th>
                </tr>
              </thead>
              <tbody id="tabla-pagos-hoy">
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Results Table -->
      <div class="table-container" id="tabla-resultados">
        <h5 class="mb-3"><i class="bi bi-table"></i> Turnos de Hoy</h5>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Hora</th>
                <th>Paciente</th>
                <th>DNI</th>
                <th>Médico</th>
                <th>Estado</th>
                <th>Obra Social</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla-turnos-body">
              <!-- Datos se cargan dinámicamente -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Back Button -->
      <div class="text-center mt-4">
        <a href="/" class="btn btn-outline-secondary btn-lg">
          <i class="bi bi-arrow-left"></i> Volver al Panel Principal
        </a>
      </div>
      
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    let pacientes = [];
    let turnos = [];
    let medicos = [];
    let pagos = [];
    let estadisticasPagos = {};
    
    // Cargar datos iniciales
    async function cargarDatos() {
      try {
        // Cargar pacientes
        const resPacientes = await fetch('/api/pacientes');
        pacientes = await resPacientes.json();
        
        // Cargar turnos
        const resTurnos = await fetch('/api/turnos');
        turnos = await resTurnos.json();
        
        // Cargar pagos
        const resPagos = await fetch('/api/pagos');
        pagos = await resPagos.json();
        
        // Cargar estadísticas de pagos
        const resEstadisticas = await fetch('/api/pagos/estadisticas');
        estadisticasPagos = await resEstadisticas.json();
        
        // Extraer médicos únicos
        medicos = [...new Set(turnos.map(t => t.medico))];
        
        // Actualizar estadísticas
        actualizarEstadisticas();
        
        // Cargar tabla de turnos de hoy
        cargarTurnosHoy();
        
        // Cargar opciones de médicos
        cargarOpcionesMedicos();
        
        // Configurar fecha de pagos a hoy
        document.getElementById('fecha-pagos').value = new Date().toISOString().split('T')[0];
        
      } catch (error) {
        console.error('Error cargando datos:', error);
      }
    }
    
    function actualizarEstadisticas() {
      const hoy = new Date().toISOString().split('T')[0];
      const turnosHoy = turnos.filter(t => t.fecha === hoy);
      const turnosPendientes = turnos.filter(t => ['sin atender', 'llamado'].includes(t.estado));
      
      document.getElementById('total-pacientes').textContent = pacientes.length;
      document.getElementById('total-turnos').textContent = turnos.length;
      document.getElementById('turnos-hoy').textContent = turnosHoy.length;
      document.getElementById('turnos-pendientes').textContent = turnosPendientes.length;
      
      // Actualizar estadísticas de pagos
      document.getElementById('total-dia').textContent = `$${estadisticasPagos.total_dia || 0}`;
      document.getElementById('total-mes').textContent = `$${estadisticasPagos.total_mes || 0}`;
    }
    
    function cargarTurnosHoy() {
      const hoy = new Date().toISOString().split('T')[0];
      const turnosHoy = turnos.filter(t => t.fecha === hoy);
      mostrarTurnosEnTabla(turnosHoy);
    }
    
    function mostrarTurnosEnTabla(turnosMostrar) {
      const tbody = document.getElementById('tabla-turnos-body');
      tbody.innerHTML = '';
      
      if (turnosMostrar.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No hay turnos para mostrar</td></tr>';
        return;
      }
      
      turnosMostrar.forEach(turno => {
        const paciente = pacientes.find(p => p.dni === turno.dni_paciente) || {};
        const estadoColor = {
          'sin atender': 'warning',
          'llamado': 'info',
          'atendido': 'success',
          'ausente': 'danger'
        }[turno.estado] || 'secondary';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${turno.hora}</strong></td>
          <td>${paciente.nombre || ''} ${paciente.apellido || ''}</td>
          <td>${turno.dni_paciente}</td>
          <td>${turno.medico}</td>
          <td><span class="badge bg-${estadoColor}">${turno.estado}</span></td>
          <td>${paciente.obra_social || '-'}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="editarTurno('${turno.dni_paciente}', '${turno.fecha}', '${turno.hora}')">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-outline-danger" onclick="eliminarTurno('${turno.dni_paciente}', '${turno.fecha}', '${turno.hora}')">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }
    
    function cargarOpcionesMedicos() {
      const select = document.getElementById('filtro-medico');
      medicos.forEach(medico => {
        const option = document.createElement('option');
        option.value = medico;
        option.textContent = medico;
        select.appendChild(option);
      });
    }
    
    function mostrarBusquedaAvanzada() {
      const busquedaAvanzada = document.getElementById('busqueda-avanzada');
      busquedaAvanzada.style.display = busquedaAvanzada.style.display === 'none' ? 'block' : 'none';
    }
    
    function buscarPaciente() {
      const texto = document.getElementById('buscar-paciente').value.toLowerCase();
      const fecha = document.getElementById('buscar-fecha').value;
      
      let turnosFiltrados = turnos;
      
      if (texto) {
        turnosFiltrados = turnosFiltrados.filter(turno => {
          const paciente = pacientes.find(p => p.dni === turno.dni_paciente) || {};
          return turno.dni_paciente.includes(texto) ||
                 (paciente.nombre && paciente.nombre.toLowerCase().includes(texto)) ||
                 (paciente.apellido && paciente.apellido.toLowerCase().includes(texto));
        });
      }
      
      if (fecha) {
        turnosFiltrados = turnosFiltrados.filter(turno => turno.fecha === fecha);
      }
      
      mostrarTurnosEnTabla(turnosFiltrados);
    }
    
    function limpiarBusqueda() {
      document.getElementById('buscar-paciente').value = '';
      document.getElementById('buscar-fecha').value = '';
      cargarTurnosHoy();
    }
    
    function aplicarFiltrosAvanzados() {
      const medico = document.getElementById('filtro-medico').value;
      const estado = document.getElementById('filtro-estado').value;
      const obraSocial = document.getElementById('filtro-obra-social').value.toLowerCase();
      
      let turnosFiltrados = turnos;
      
      if (medico) {
        turnosFiltrados = turnosFiltrados.filter(t => t.medico === medico);
      }
      
      if (estado) {
        turnosFiltrados = turnosFiltrados.filter(t => t.estado === estado);
      }
      
      if (obraSocial) {
        turnosFiltrados = turnosFiltrados.filter(turno => {
          const paciente = pacientes.find(p => p.dni === turno.dni_paciente) || {};
          return paciente.obra_social && paciente.obra_social.toLowerCase().includes(obraSocial);
        });
      }
      
      mostrarTurnosEnTabla(turnosFiltrados);
    }
    
    async function editarTurno(dni, fecha, hora) {
      const nuevaHora = prompt('Ingrese la nueva hora (HH:MM):', hora);
      if (nuevaHora && nuevaHora !== hora) {
        try {
          const response = await fetch(`/api/turnos/${dni}/${fecha}/${hora}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              nueva_hora: nuevaHora
            })
          });
          
          const result = await response.json();
          
          if (response.ok) {
            alert('Turno actualizado correctamente');
            cargarDatos(); // Recargar los datos
          } else {
            alert('Error: ' + result.error);
          }
        } catch (error) {
          alert('Error al actualizar el turno: ' + error.message);
        }
      }
    }
    
    async function eliminarTurno(dni, fecha, hora) {
      if (confirm('¿Está seguro de que desea eliminar este turno?')) {
        try {
          const response = await fetch(`/api/turnos/${dni}/${fecha}/${hora}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
            }
          });
          
          const result = await response.json();
          
          if (response.ok) {
            alert('Turno eliminado correctamente');
            cargarDatos(); // Recargar los datos
          } else {
            alert('Error: ' + result.error);
          }
        } catch (error) {
          alert('Error al eliminar el turno: ' + error.message);
        }
      }
    }
    
    // === FUNCIONES DE PAGOS ===
    
    function mostrarGestionPagos() {
      const gestionPagos = document.getElementById('gestion-pagos');
      gestionPagos.style.display = gestionPagos.style.display === 'none' ? 'block' : 'none';
      
      if (gestionPagos.style.display === 'block') {
        cargarPagosHoy();
      }
    }
    
    async function cargarPacientesAtendidos() {
      const fecha = document.getElementById('fecha-pagos').value;
      if (!fecha) {
        alert('Por favor seleccione una fecha');
        return;
      }
      
      try {
        const response = await fetch(`/api/pacientes/atendidos?fecha=${fecha}`);
        const pacientesAtendidos = await response.json();
        
        const tbody = document.getElementById('tabla-pacientes-pagar');
        tbody.innerHTML = '';
        
        if (pacientesAtendidos.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No hay pacientes atendidos pendientes de pago</td></tr>';
          document.getElementById('pacientes-pagar').style.display = 'block';
          return;
        }
        
        pacientesAtendidos.forEach(paciente => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${paciente.apellido}</td>
            <td>${paciente.nombre}</td>
            <td>${paciente.dni}</td>
            <td>${paciente.hora_turno}</td>
            <td>${paciente.medico}</td>
            <td>
              <input type="number" class="form-control form-control-sm" 
                     id="monto-${paciente.dni}" placeholder="0.00" step="0.01" min="0">
            </td>
            <td>
              <button class="btn btn-sm btn-success" 
                      onclick="registrarPago('${paciente.dni}', '${fecha}')">
                <i class="bi bi-check-circle"></i> Registrar
              </button>
            </td>
          `;
          tbody.appendChild(row);
        });
        
        document.getElementById('pacientes-pagar').style.display = 'block';
        
      } catch (error) {
        alert('Error al cargar pacientes atendidos: ' + error.message);
      }
    }
    
    async function registrarPago(dni, fecha) {
      const montoInput = document.getElementById(`monto-${dni}`);
      const monto = parseFloat(montoInput.value);
      
      if (!monto || monto <= 0) {
        alert('Por favor ingrese un monto válido');
        return;
      }
      
      const observaciones = prompt('Observaciones (opcional):') || '';
      
      try {
        const response = await fetch('/api/pagos', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            dni_paciente: dni,
            monto: monto,
            fecha: fecha,
            observaciones: observaciones
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('Pago registrado correctamente');
          cargarDatos(); // Recargar estadísticas
          cargarPacientesAtendidos(); // Actualizar tabla
          cargarPagosHoy(); // Actualizar historial
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error al registrar pago: ' + error.message);
      }
    }
    
    async function cargarPagosHoy() {
      const fecha = document.getElementById('fecha-pagos').value || new Date().toISOString().split('T')[0];
      const pagosHoy = pagos.filter(p => p.fecha === fecha);
      
      const tbody = document.getElementById('tabla-pagos-hoy');
      tbody.innerHTML = '';
      
      if (pagosHoy.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay pagos registrados para esta fecha</td></tr>';
        return;
      }
      
      pagosHoy.forEach(pago => {
        const row = document.createElement('tr');
        const paciente = pacientes.find(p => p.dni === pago.dni_paciente) || {};
        
        row.innerHTML = `
          <td>${paciente.apellido || ''}</td>
          <td>${paciente.nombre || ''}</td>
          <td>${pago.dni_paciente}</td>
          <td>$${pago.monto}</td>
          <td>${pago.observaciones || '-'}</td>
        `;
        tbody.appendChild(row);
      });
    }
    
    async function exportarPagosCSV() {
      try {
        const response = await fetch('/api/pagos/exportar');
        
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = `pagos_${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          
          alert('Archivo CSV descargado correctamente');
        } else {
          alert('Error al exportar archivo CSV');
        }
      } catch (error) {
        alert('Error al exportar CSV: ' + error.message);
      }
    }
    
    // Cargar datos al iniciar la página
    document.addEventListener('DOMContentLoaded', cargarDatos);
  </script>
</body>
</html>
