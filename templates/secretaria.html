<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Secretar√≠a - Cl√≠nica</title>
  
  <!-- Bootstrap & Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .dashboard-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      padding: 2rem;
      margin: 2rem;
    }

    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border-left: 4px solid;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }
    .stat-card[onclick]:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 40px rgba(0, 123, 255, 0.3);
      border-left-width: 6px;
    }
     
    .text-purple {
      color: #6f42c1 !important;
    }

    .stat-card.patients { border-left-color: #28a745; }
    .stat-card.appointments { border-left-color: #007bff; }
    .stat-card.today { border-left-color: #ffc107; }
    .stat-card.pending { border-left-color: #dc3545; }

    .action-btn {
      background: linear-gradient(45deg, #667eea, #764ba2);
      border: none;
      border-radius: 15px;
      padding: 1rem 1.5rem;
      color: white;
      font-weight: 600;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      transition: all 0.3s ease;
      margin: 0.5rem;
    }
    
    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      color: white;
    }

    .action-btn i {
      margin-right: 0.5rem;
      font-size: 1.2rem;
    }
    
    .quick-search {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      margin-bottom: 2rem;
    }
    
    .table-container {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      margin-top: 2rem;
    }
    
    .title-section {
      text-align: center;
      margin-bottom: 2rem;
    }

    .title-section h1 {
      color: #2c3e50;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .title-section p {
      color: #6c757d;
      font-size: 1.1rem;
    }
    
    .btn-custom {
      border-radius: 10px;
      padding: 0.5rem 1rem;
      font-weight: 600;
      border: none;
      transition: all 0.3s ease;
    }
    
    .btn-custom:hover {
      transform: translateY(-1px);
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="dashboard-container">
      
      <!-- Header -->
      <div class="title-section">
        <h1><i class="bi bi-clipboard2-data"></i> Panel de Secretar√≠a</h1>
        <p>Gesti√≥n completa de pacientes, turnos y agenda m√©dica</p>
      </div>
      
      <!-- Statistics Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="stat-card patients">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-1">Total Pacientes</h6>
                <h3 class="mb-0" id="total-pacientes">0</h3>
              </div>
              <i class="bi bi-people-fill fs-1 text-success opacity-50"></i>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="stat-card appointments">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-1">Turnos Totales</h6>
                <h3 class="mb-0" id="total-turnos">0</h3>
              </div>
              <i class="bi bi-calendar-check-fill fs-1 text-primary opacity-50"></i>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="stat-card today">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-1">Turnos Hoy</h6>
                <h3 class="mb-0" id="turnos-hoy">0</h3>
              </div>
              <i class="bi bi-calendar-day-fill fs-1 text-warning opacity-50"></i>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="stat-card pending">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-1">Pendientes</h6>
                <h3 class="mb-0" id="turnos-pendientes">0</h3>
              </div>
              <i class="bi bi-clock-fill fs-1 text-danger opacity-50"></i>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Finance Statistics -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="stat-card" style="border-left-color: #28a745;">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-1">Ingresos del D√≠a</h6>
                <h3 class="mb-0" id="total-dia">$0</h3>
                <small class="text-muted" id="detalle-ingresos">0 pagos</small>
              </div>
              <i class="bi bi-cash-coin fs-1 text-success opacity-50"></i>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="stat-card" style="border-left-color: #007bff;">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-1">Efectivo</h6>
                <h3 class="mb-0" id="total-efectivo-dia">$0</h3>
                <small class="text-muted" id="cantidad-efectivo-dia">0 pagos</small>
              </div>
              <i class="bi bi-cash fs-1 text-primary opacity-50"></i>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="stat-card" style="border-left-color: #17a2b8;">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-1">Transferencias</h6>
                <h3 class="mb-0" id="total-transferencia-dia">$0</h3>
                <small class="text-muted" id="cantidad-transferencia-dia">0 pagos</small>
              </div>
              <i class="bi bi-bank fs-1 text-info opacity-50"></i>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="stat-card" style="border-left-color: #ffc107;">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-1">Pendientes Cobro</h6>
                <h3 class="mb-0" id="pendientes-cobro">0</h3>
              </div>
              <i class="bi bi-clock-history fs-1 text-warning opacity-50"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="text-center">
            <a href="/pacientes" class="action-btn">
              <i class="bi bi-person-plus"></i> Registrar Pacientes
            </a>
            <a href="/turnos" class="action-btn">
              <i class="bi bi-clipboard2-check"></i> Gestionar Turnos
            </a>
            <a href="/agenda" class="action-btn">
              <i class="bi bi-calendar-week"></i> Administrar Agenda
            </a>
            <button class="action-btn" onclick="mostrarBusquedaAvanzada()">
              <i class="bi bi-search"></i> B√∫squeda Avanzada
            </button>
            <button class="action-btn" onclick="mostrarGestionPagos()">
              <i class="bi bi-cash-stack"></i> Gesti√≥n de Pagos
            </button>
          </div>
        </div>
      </div>

       <!-- Quick Search -->
      <div class="quick-search" id="busqueda-rapida">
        <h5 class="mb-3"><i class="bi bi-search"></i> B√∫squeda R√°pida</h5>
        <div class="row">
          <div class="col-md-4">
            <input type="text" id="buscar-paciente" class="form-control" placeholder="Buscar paciente por nombre o DNI">
          </div>
          <div class="col-md-4">
            <input type="date" id="buscar-fecha" class="form-control">
          </div>
          <div class="col-md-4">
            <div class="d-flex gap-2">
              <button class="btn btn-primary btn-custom" onclick="buscarPaciente()">
                <i class="bi bi-search"></i> Buscar
              </button>
              <button class="btn btn-secondary btn-custom" onclick="limpiarBusqueda()">
                <i class="bi bi-arrow-clockwise"></i> Limpiar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Advanced Search (Hidden by default) -->
      <div class="quick-search" id="busqueda-avanzada" style="display: none;">
        <h5 class="mb-3"><i class="bi bi-funnel"></i> B√∫squeda Avanzada</h5>
        <div class="row">
          <div class="col-md-3">
            <select id="filtro-medico" class="form-select">
              <option value="">Todos los m√©dicos</option>
            </select>
          </div>
          <div class="col-md-3">
            <select id="filtro-estado" class="form-select">
              <option value="">Todos los estados</option>
              <option value="sin atender">Sin atender</option>
              <option value="recepcionado">Recepcionado</option>
              <option value="sala de espera">Sala de espera</option>
              <option value="llamado">Llamado</option>
              <option value="atendido">Atendido</option>
              <option value="ausente">Ausente</option>
            </select>
          </div>
          <div class="col-md-3">
            <input type="text" id="filtro-obra-social" class="form-control" placeholder="Obra social">
          </div>
          <div class="col-md-3">
            <button class="btn btn-success btn-custom w-100" onclick="aplicarFiltrosAvanzados()">
              <i class="bi bi-funnel-fill"></i> Aplicar Filtros
            </button>
          </div>
        </div>
      </div>
      

    <!-- Payment Management Section -->
    <div class="quick-search" id="gestion-pagos" style="display: none;">
      <h5 class="mb-3"><i class="bi bi-cash-stack"></i> Gesti√≥n de Pagos</h5>
        
      <!-- Payment Statistics and Export -->
        <div class="row mb-3">
          <div class="col-md-6">
            <input type="date" id="fecha-pagos" class="form-control" value="" onchange="actualizarGestionPagos()">
            <small class="text-muted">Seleccione fecha para ver pagos y recepcionados</small>
          </div>
          <div class="col-md-6">
          <div class="d-flex gap-2">
              <button class="btn btn-primary btn-custom" onclick="actualizarGestionPagos()">
                <i class="bi bi-arrow-clockwise"></i> Actualizar
              </button>
              <button class="btn btn-info btn-custom" onclick="exportarPagosCSV()">
                <i class="bi bi-download"></i> Exportar CSV
              </button>
            </div>
          </div>
        </div> 
        
              <!-- Patients waiting for payment -->
        <div id="pacientes-cobrar">
          <h6 class="mb-2"><i class="bi bi-people-fill"></i> Pacientes Recepcionados - Pendientes de Cobro</h6>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead class="table-light">
                <tr>
                  <th>Hora</th>
                  <th>Apellido</th>
                  <th>Nombre</th>
                  <th>DNI</th>
                  <th>Obra Social</th>
                  <th>M√©dico</th>
                  <th>Monto</th>
                  <th>Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="tabla-pacientes-cobrar">
                <!-- Se cargan din√°micamente -->
              </tbody>
            </table>
          </div>
        </div>
         
        <!-- Information Panel -->
        <div id="info-flujo-pago" class="alert alert-info mt-3">
          <h6 class="mb-2"><i class="bi bi-info-circle"></i> Flujo de Pagos</h6>
          <p class="mb-1"><strong>1. Recepcionar:</strong> Cuando llega el paciente (Gesti√≥n de Turnos)</p>
          <p class="mb-1"><strong>2. Cobrar:</strong> Desde aqu√≠ o desde Gesti√≥n de Turnos</p>
          <p class="mb-0"><strong>3. M√©dico:</strong> Llamar desde sala de espera ‚Üí atender</p>
        </div>
        <!-- Payment History -->
        <div id="historial-pagos">
          <h6 class="mb-2">Pagos Registrados Hoy</h6>
          
          <!-- Resumen de totales por tipo de pago -->
          <div class="row mb-3">
            <div class="col-md-3">
              <div class="card border-primary">
                <div class="card-body text-center py-2">
                  <h6 class="card-title text-primary mb-1">Efectivo</h6>
                  <h5 class="mb-0" id="total-efectivo-resumen">$0</h5>
                  <small class="text-muted" id="cantidad-efectivo-resumen">0 pagos</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-info">
                <div class="card-body text-center py-2">
                  <h6 class="card-title text-info mb-1">Transferencias</h6>
                  <h5 class="mb-0" id="total-transferencia-resumen">$0</h5>
                  <small class="text-muted" id="cantidad-transferencia-resumen">0 pagos</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-success">
                <div class="card-body text-center py-2">
                  <h6 class="card-title text-success mb-1">Obra Social</h6>
                  <h5 class="mb-0" id="total-obra-social-resumen">$0</h5>
                  <small class="text-muted" id="cantidad-obra-social-resumen">0 consultas</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-warning">
                <div class="card-body text-center py-2">
                  <h6 class="card-title text-warning mb-1">Total Recaudado</h6>
                  <h5 class="mb-0" id="total-recaudado-resumen">$0</h5>
                  <small class="text-muted">Efectivo + Transferencias</small>
                </div>
              </div>
            </div>
          </div>
          
          <div class="table-responsive">
            <table class="table table-sm">
              <thead class="table-light">
                <tr>
                  <th>Apellido</th>
                  <th>Nombre</th>
                  <th>DNI</th>
                  <th>Monto</th>
                  <th>Obra Social</th>
                  <th>Tipo de Pago</th>
                  <th>Observaciones</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="tabla-pagos-hoy">
              </tbody>
            </table>
          </div>
        </div>
      </div>

        <!-- Results Table -->
      <div class="table-container" id="tabla-resultados">
        <h5 class="mb-3"><i class="bi bi-table"></i> Turnos de Hoy</h5>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Hora</th>
                <th>Paciente</th>
                <th>DNI</th>
                <th>M√©dico</th>
                <th>Estado</th>
                <th>Obra Social</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla-turnos-body">
              <!-- Datos se cargan din√°micamente -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Bot√≥n Volver al Panel Principal destacado arriba -->
      <div class="mb-4 text-start">
        <a href="/" class="btn btn-lg btn-outline-secondary shadow-sm">
          <i class="bi bi-arrow-left"></i> Volver al Panel Principal
        </a>
      </div>
      
    </div>
<!-- Bot√≥n para vaciar turnos vencidos (solo secretaria) -->
{% if session['rol'] == 'secretaria' %}
<div class="mb-4 text-end">
  <button class="btn btn-danger btn-lg" onclick="vaciarTurnosVencidos()">
    <i class="bi bi-trash"></i> Vaciar turnos vencidos (24hs)
  </button>
</div>
<script>
function vaciarTurnosVencidos() {
  if (!confirm("¬øSeguro que quieres eliminar todos los turnos 'sin atender' vencidos hace m√°s de 24hs?")) return;
  fetch('/api/turnos/limpiar-vencidos', {method: 'POST'})
    .then(r => r.json())
    .then(res => {
      alert(`Turnos eliminados: ${res.eliminados}`);
      // Recargar la tabla de turnos si existe funci√≥n
      if (typeof cargarTurnosHoy === 'function') cargarTurnosHoy();
    });
}
</script>
{% endif %}
<!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    let pacientes = [];
    let turnos = [];
    let medicos = [];
    let pagos = [];
    let estadisticasPagos = {};
    
    // Cargar datos iniciales
    async function cargarDatos() {
      try {
        // Cargar pacientes
        const resPacientes = await fetch('/api/pacientes');
        pacientes = await resPacientes.json();
        
        // Cargar turnos
        const resTurnos = await fetch('/api/turnos');
        turnos = await resTurnos.json();
        
        // Cargar pagos
        const resPagos = await fetch('/api/pagos');
        pagos = await resPagos.json();
        
        // Cargar estad√≠sticas de pagos del mes actual
        const fechaHoy = new Date();
        const mesActual = `${fechaHoy.getFullYear()}-${String(fechaHoy.getMonth() + 1).padStart(2, '0')}`;
        const resEstadisticas = await fetch(`/api/pagos/estadisticas?mes=${mesActual}`);
        estadisticasPagos = await resEstadisticas.json();

        // Extraer m√©dicos √∫nicos
        medicos = [...new Set(turnos.map(t => t.medico))];
        
        // Actualizar estad√≠sticas
        await actualizarEstadisticas();
        
        // Cargar tabla de turnos de hoy
        await cargarTurnosHoy();
        
        // Configurar fechas a hoy
        const fechaActual = new Date().toISOString().split('T')[0];
        document.getElementById('fecha-pagos').value = fechaActual;
        document.getElementById('buscar-fecha').value = fechaActual;
        
        // Configurar fecha de pagos a hoy
        document.getElementById('fecha-pagos').value = new Date().toISOString().split('T')[0];
        
      } catch (error) {
        console.error('Error cargando datos:', error);
      }
    }
     
    async function actualizarEstadisticas() {
      const hoy = new Date().toISOString().split('T')[0];
      const turnosHoy = turnos.filter(t => t.fecha === hoy);
      const turnosPendientes = turnos.filter(t => ['sin atender', 'llamado'].includes(t.estado));
      
      // Obtener pacientes recepcionados pendientes de cobro
      let pacientesRecepcionados = 0;
      try {
        const response = await fetch(`/api/pacientes/recepcionados?fecha=${hoy}`);
        const recepcionados = await response.json();
        pacientesRecepcionados = recepcionados.length;
      } catch (error) {
        console.error('Error obteniendo recepcionados:', error);
      }
      document.getElementById('total-pacientes').textContent = pacientes.length;
      document.getElementById('total-turnos').textContent = turnos.length;
      document.getElementById('turnos-hoy').textContent = turnosHoy.length;
      document.getElementById('turnos-pendientes').textContent = turnosPendientes.length;
      document.getElementById('pendientes-cobro').textContent = pacientesRecepcionados;
      
    
     
      // Actualizar estad√≠sticas de pagos
      document.getElementById('total-dia').textContent = `$${estadisticasPagos.total_dia || 0}`;
      document.getElementById('total-mes').textContent = `$${estadisticasPagos.total_mes || 0}`;
      
      // Actualizar estad√≠sticas por tipo de pago del d√≠a
      document.getElementById('total-efectivo-dia').textContent = `$${estadisticasPagos.total_efectivo_hoy || 0}`;
      document.getElementById('total-transferencia-dia').textContent = `$${estadisticasPagos.total_transferencia_hoy || 0}`;
      document.getElementById('cantidad-efectivo-dia').textContent = `${estadisticasPagos.pagos_efectivo_hoy || 0} pagos`;
      document.getElementById('cantidad-transferencia-dia').textContent = `${estadisticasPagos.pagos_transferencia_hoy || 0} pagos`;
      document.getElementById('detalle-ingresos').textContent = `${estadisticasPagos.cantidad_pagos_dia || 0} pagos`;
    }
    
    async function cargarTurnosHoy() {
      const hoy = new Date().toISOString().split('T')[0];
      try {
         // Usar la API espec√≠fica para turnos del d√≠a que incluye informaci√≥n del paciente
        const response = await fetch(`/api/turnos/dia?fecha=${hoy}`);
        const turnosHoy = await response.json();
        mostrarTurnosEnTabla(turnosHoy);
       } catch (error) {
        console.error('Error cargando turnos de hoy:', error);
        // Fallback: usar datos ya cargados
        const turnosHoy = turnos.filter(t => t.fecha === hoy);
        mostrarTurnosEnTabla(turnosHoy);
      }
    }
    
    function mostrarTurnosEnTabla(turnosMostrar) {
      const tbody = document.getElementById('tabla-turnos-body');
      tbody.innerHTML = '';
      
      if (turnosMostrar.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No hay turnos para mostrar hoy</td></tr>';
        return;
      }
      // Ordenar por hora
      turnosMostrar.sort((a, b) => (a.hora || '00:00').localeCompare(b.hora || '00:00'));
       
      turnosMostrar.forEach(turno => {
        // Usar paciente enriquecido de la API o buscar en el array local
        const paciente = turno.paciente || pacientes.find(p => p.dni === turno.dni_paciente) || {};
         
        // Colores para todos los estados
        const estadoColor = {
          'sin atender': 'secondary',
          'recepcionado': 'success',
          'sala de espera': 'primary',
          'llamado': 'warning',
          'atendido': 'success',
          'ausente': 'danger'
        }[turno.estado] || 'secondary';

        // Iconos para cada estado
        const estadoIcon = {
          'sin atender': '‚è≥',
          'recepcionado': '‚úÖ',
          'sala de espera': 'üè•',
          'llamado': 'üìû',
          'atendido': '‚úîÔ∏è',
          'ausente': '‚ùå'
        }[turno.estado] || '‚è≥';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${turno.hora}</strong></td>
          <td>${paciente.nombre || ''} ${paciente.apellido || ''}</td>
          <td>${turno.dni_paciente}</td>
          <td>${turno.medico}</td>
          <td><span class="badge bg-${estadoColor}">${estadoIcon} ${turno.estado}</span></td>
          <td>${paciente.obra_social || '-'}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="editarTurno('${turno.dni_paciente}', '${turno.fecha}', '${turno.hora}')">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-outline-danger" onclick="eliminarTurno('${turno.dni_paciente}', '${turno.fecha}', '${turno.hora}')">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function cargarOpcionesMedicos() {
      const select = document.getElementById('filtro-medico');
      medicos.forEach(medico => {
        const option = document.createElement('option');
        option.value = medico;
        option.textContent = medico;
        select.appendChild(option);
      });
    }
    
    function mostrarBusquedaAvanzada() {
      const busquedaAvanzada = document.getElementById('busqueda-avanzada');
      busquedaAvanzada.style.display = busquedaAvanzada.style.display === 'none' ? 'block' : 'none';
    }
    
    async function buscarPaciente() {
      const texto = document.getElementById('buscar-paciente').value.toLowerCase();
      const fecha = document.getElementById('buscar-fecha').value || new Date().toISOString().split('T')[0];
      
      try {
         // Obtener turnos de la fecha espec√≠fica
        const response = await fetch(`/api/turnos/dia?fecha=${fecha}`);
        let turnosFiltrados = await response.json();
         
        // Aplicar filtro de texto si existe
        if (texto) {
          turnosFiltrados = turnosFiltrados.filter(turno => {
            const paciente = turno.paciente || {};
            return turno.dni_paciente.includes(texto) ||
                  (paciente.nombre && paciente.nombre.toLowerCase().includes(texto)) ||
                  (paciente.apellido && paciente.apellido.toLowerCase().includes(texto));
          });
        }
         
        mostrarTurnosEnTabla(turnosFiltrados);
      } catch (error) {
        console.error('Error buscando pacientes:', error);
        alert('Error al buscar pacientes');
      }
    }
    
    async function limpiarBusqueda() {
      document.getElementById('buscar-paciente').value = '';
      document.getElementById('buscar-fecha').value = '';
      await cargarTurnosHoy();
    }
    
    async function aplicarFiltrosAvanzados() {
      const medico = document.getElementById('filtro-medico').value;
      const estado = document.getElementById('filtro-estado').value;
      const obraSocial = document.getElementById('filtro-obra-social').value.toLowerCase();
      const fecha = document.getElementById('buscar-fecha').value || new Date().toISOString().split('T')[0];

      try {
        // Obtener turnos m√°s recientes de la fecha
        const response = await fetch(`/api/turnos/dia?fecha=${fecha}`);
        let turnosFiltrados = await response.json();
         
        if (medico) {
          turnosFiltrados = turnosFiltrados.filter(t => t.medico === medico);
        }
         
        if (estado) {
          turnosFiltrados = turnosFiltrados.filter(t => t.estado === estado);
        }
         
        if (obraSocial) {
          turnosFiltrados = turnosFiltrados.filter(turno => {
            const paciente = turno.paciente || {};
            return paciente.obra_social && paciente.obra_social.toLowerCase().includes(obraSocial);
          });
        }
         
        mostrarTurnosEnTabla(turnosFiltrados);
      } catch (error) {
        console.error('Error aplicando filtros:', error);
        alert('Error al aplicar filtros');
      }
    }

    async function editarTurno(dni, fecha, hora) {
      const nuevaHora = prompt('Ingrese la nueva hora (HH:MM):', hora);
      const nuevaFecha = prompt('Ingrese la nueva fecha (YYYY-MM-DD):', fecha);
      
      if ((nuevaHora && nuevaHora !== hora) || (nuevaFecha && nuevaFecha !== fecha)) {
        try {
          const data = {};
          if (nuevaHora && nuevaHora !== hora) data.nueva_hora = nuevaHora;
          if (nuevaFecha && nuevaFecha !== fecha) data.nueva_fecha = nuevaFecha;
          
          const response = await fetch(`/api/turnos/${dni}/${fecha}/${hora}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
          });
          
          const result = await response.json();
          
          if (response.ok) {
            alert('Turno actualizado correctamente');
            await cargarDatos(); // Recargar los datos
          } else {
            alert('Error: ' + result.error);
          }
        } catch (error) {
          alert('Error al actualizar el turno: ' + error.message);
        }
      }
    }

    async function eliminarTurno(dni, fecha, hora) {
      if (confirm('¬øEst√° seguro de que desea eliminar este turno?')) {
        try {
          const response = await fetch(`/api/turnos/${dni}/${fecha}/${hora}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
            }
          });
          
          const result = await response.json();
          
          if (response.ok) {
            alert('Turno eliminado correctamente');
            await cargarDatos(); // Recargar los datos
          } else {
            alert('Error: ' + result.error);
          }
        } catch (error) {
          alert('Error al eliminar el turno: ' + error.message);
        }
      }
    }

    // === FUNCIONES DE PAGOS ===
    
    function mostrarGestionPagos() {
      const gestionPagos = document.getElementById('gestion-pagos');
      gestionPagos.style.display = gestionPagos.style.display === 'none' ? 'block' : 'none';
      
      if (gestionPagos.style.display === 'block') {
        cargarPacientesRecepcionados();
        cargarPagosHoy();
      }
    }
    
    function actualizarGestionPagos() {
      cargarPacientesRecepcionados();
      cargarPagosHoy();
    }



    
    async function cargarPagosHoy() {
      const fecha = document.getElementById('fecha-pagos').value || new Date().toISOString().split('T')[0];
      const pagosHoy = pagos.filter(p => p.fecha === fecha);
      
      const tbody = document.getElementById('tabla-pagos-hoy');
      tbody.innerHTML = '';
      
      if (pagosHoy.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No hay pagos registrados para esta fecha</td></tr>';
        
        // Limpiar resumen cuando no hay pagos
        document.getElementById('total-efectivo-resumen').textContent = '$0';
        document.getElementById('total-transferencia-resumen').textContent = '$0';
        document.getElementById('total-obra-social-resumen').textContent = '$0';
        document.getElementById('total-recaudado-resumen').textContent = '$0';
        document.getElementById('cantidad-efectivo-resumen').textContent = '0 pagos';
        document.getElementById('cantidad-transferencia-resumen').textContent = '0 pagos';
        document.getElementById('cantidad-obra-social-resumen').textContent = '0 consultas';
        return;
      }

      // Calcular totales por tipo de pago
      let totalEfectivo = 0;
      let totalTransferencia = 0;
      let totalObraSocial = 0;
      let cantidadEfectivo = 0;
      let cantidadTransferencia = 0;
      let cantidadObraSocial = 0;

      pagosHoy.forEach(pago => {
        const row = document.createElement('tr');
        const paciente = pacientes.find(p => p.dni === pago.dni_paciente) || {};
        
        // Determinar color del monto seg√∫n si es gratis o pagado
        const montoColor = pago.monto == 0 ? 'text-success' : 'text-primary';
        const montoTexto = pago.monto == 0 ? 'Obra Social' : `$${pago.monto}`;
        
        // Determinar tipo de pago y su badge
        let tipoPagoBadge = '';
        if (pago.monto == 0) {
          tipoPagoBadge = '<span class="badge bg-success">Obra Social</span>';
          totalObraSocial += pago.monto;
          cantidadObraSocial++;
        } else {
          const tipoPago = pago.tipo_pago || 'efectivo';
          const badgeClass = tipoPago === 'efectivo' ? 'bg-primary' : 'bg-info';
          const badgeText = tipoPago === 'efectivo' ? 'Efectivo' : 'Transferencia';
          tipoPagoBadge = `<span class="badge ${badgeClass}">${badgeText}</span>`;
          
          if (tipoPago === 'efectivo') {
            totalEfectivo += pago.monto;
            cantidadEfectivo++;
          } else {
            totalTransferencia += pago.monto;
            cantidadTransferencia++;
          }
        }
         
        row.innerHTML = `
          <td>${paciente.apellido || ''}</td>
          <td>${paciente.nombre || ''}</td>
          <td>${pago.dni_paciente}</td>
          <td class="${montoColor}"><strong>${montoTexto}</strong></td>
          <td>${pago.obra_social || '-'}</td>
          <td>${tipoPagoBadge}</td>
          <td>${pago.observaciones || '-'}</td>
          <td>
            <button class="btn btn-sm btn-outline-danger" onclick="eliminarPago(${pago.id}, '${pago.nombre_paciente}')">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
      
      // Actualizar resumen de totales
      document.getElementById('total-efectivo-resumen').textContent = `$${totalEfectivo}`;
      document.getElementById('total-transferencia-resumen').textContent = `$${totalTransferencia}`;
      document.getElementById('total-obra-social-resumen').textContent = `$${totalObraSocial}`;
      document.getElementById('total-recaudado-resumen').textContent = `$${totalEfectivo + totalTransferencia}`;
      document.getElementById('cantidad-efectivo-resumen').textContent = `${cantidadEfectivo} pagos`;
      document.getElementById('cantidad-transferencia-resumen').textContent = `${cantidadTransferencia} pagos`;
      document.getElementById('cantidad-obra-social-resumen').textContent = `${cantidadObraSocial} consultas`;
    }
    
    async function cargarPacientesRecepcionados() {
      const fecha = document.getElementById('fecha-pagos').value || new Date().toISOString().split('T')[0];
      
      try {
        const response = await fetch(`/api/pacientes/recepcionados?fecha=${fecha}`);
        const pacientesRecepcionados = await response.json();
        
        const tbody = document.getElementById('tabla-pacientes-cobrar');
        tbody.innerHTML = '';
        
        if (pacientesRecepcionados.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No hay pacientes recepcionados pendientes de cobro</td></tr>';
          return;
        }
        
        pacientesRecepcionados.forEach(paciente => {
          const row = document.createElement('tr');
          row.className = 'table-warning'; // Resaltar que est√°n pendientes
          
          row.innerHTML = `
            <td><strong>${paciente.hora_turno}</strong></td>
            <td>${paciente.apellido}</td>
            <td>${paciente.nombre}</td>
            <td>${paciente.dni}</td>
            <td>${paciente.obra_social || '-'}</td>
            <td>${paciente.medico}</td>
            <td>
              <input type="number" class="form-control form-control-sm" 
                     id="monto-${paciente.dni}" placeholder="0.00" step="0.01" min="0" 
                     style="width: 80px;">
            </td>
            <td>
              <button class="btn btn-sm btn-success"
                     onclick="cobrarPacienteRecepcionado('${paciente.dni}', '${fecha}')">
                <i class="bi bi-cash-coin"></i> Cobrar
              </button>
            </td>
          `;
          tbody.appendChild(row);
        });
        
      } catch (error) {
        console.error('Error cargando pacientes recepcionados:', error);
      }
    }

    async function cobrarPacienteRecepcionado(dni, fecha) {
      const montoInput = document.getElementById(`monto-${dni}`);
      const monto = parseFloat(montoInput.value || 0);
      
      if (isNaN(monto) || monto < 0) {
        alert('Por favor ingrese un monto v√°lido (puede ser 0 para obra social)');
        return;
      }
      
      // Si el monto es 0, es obra social y no necesita tipo de pago
      if (monto === 0) {
        const observaciones = prompt('Observaciones (opcional):', '') || '';
        await procesarPago(dni, fecha, monto, 'obra_social', observaciones);
        return;
      }
      
      // Para pagos particulares, mostrar modal para seleccionar tipo de pago
      mostrarModalCobro(dni, fecha, monto);
    }
    
    function mostrarModalCobro(dni, fecha, monto) {
      // Crear modal din√°micamente
      const modalHtml = `
        <div class="modal fade" id="modalCobro" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Registrar Pago</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <p><strong>Monto a cobrar:</strong> $${monto}</p>
                <div class="mb-3">
                  <label class="form-label">Tipo de Pago:</label>
                  <select class="form-select" id="tipo-pago-select">
                    <option value="efectivo">Efectivo</option>
                    <option value="transferencia">Transferencia</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Observaciones (opcional):</label>
                  <textarea class="form-control" id="observaciones-pago" rows="3" placeholder="Observaciones adicionales..."></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="confirmarPago('${dni}', '${fecha}', ${monto})">
                  <i class="bi bi-cash-coin"></i> Confirmar Pago
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Remover modal anterior si existe
      const modalAnterior = document.getElementById('modalCobro');
      if (modalAnterior) {
        modalAnterior.remove();
      }
      
      // Agregar modal al DOM
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Mostrar modal
      const modal = new bootstrap.Modal(document.getElementById('modalCobro'));
      modal.show();
    }
    
    async function confirmarPago(dni, fecha, monto) {
      const tipoPago = document.getElementById('tipo-pago-select').value;
      const observaciones = document.getElementById('observaciones-pago').value || '';
      
      // Cerrar modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('modalCobro'));
      modal.hide();
      
      await procesarPago(dni, fecha, monto, tipoPago, observaciones);
    }
    
    async function procesarPago(dni, fecha, monto, tipoPago, observaciones) {
      try {
        const response = await fetch('/api/pagos/cobrar-y-sala', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            dni_paciente: dni,
            fecha: fecha,
            monto: monto,
            tipo_pago: tipoPago,
            observaciones: observaciones
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          if (monto > 0) {
            const tipoTexto = tipoPago === 'efectivo' ? 'en efectivo' : 'por transferencia';
            alert(`‚úÖ Pago de $${monto} ${tipoTexto} registrado correctamente\nüè• Paciente movido a sala de espera`);
          } else {
            alert(`‚úÖ Consulta cubierta por obra social\nüè• Paciente movido a sala de espera`);
          }
          
          // Recargar datos
          await cargarDatos();
          await cargarTurnosHoy(); // Actualizar tabla de turnos
          cargarPacientesRecepcionados();
          cargarPagosHoy();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error al cobrar: ' + error.message);
      }
    }
    
    async function eliminarPago(pagoId, nombrePaciente) {
      if (confirm(`¬øEst√° seguro de que desea eliminar el pago de ${nombrePaciente}?`)) {
        try {
          const response = await fetch(`/api/pagos/${pagoId}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
            }
          });
          
          const result = await response.json();
          
          if (response.ok) {
            alert('Pago eliminado correctamente');
            await cargarDatos(); // Recargar estad√≠sticas
            cargarPacientesRecepcionados(); // Recargar recepcionados
            cargarPagosHoy(); // Actualizar tabla
          } else {
            alert('Error: ' + result.error);
          }
        } catch (error) {
          alert('Error al eliminar pago: ' + error.message);
        }
      }
    }
    

    async function exportarPagosCSV() {
      try {
        const response = await fetch('/api/pagos/exportar');
        
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = `pagos_${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          
          alert('Archivo CSV descargado correctamente');
        } else {
          alert('Error al exportar archivo CSV');
        }
      } catch (error) {
        alert('Error al exportar CSV: ' + error.message);
      }
    }
    
    // Cargar datos al iniciar la p√°gina
    document.addEventListener('DOMContentLoaded', cargarDatos);
  </script>
</body>
</html>
