<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Secretar√≠a - Cl√≠nica</title>
  
  <!-- Bootstrap & Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .dashboard-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      padding: 2rem;
      margin: 2rem;
    }

    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border-left: 4px solid;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }
    .stat-card[onclick]:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 40px rgba(0, 123, 255, 0.3);
      border-left-width: 6px;
    }
     
    .text-purple {
      color: #6f42c1 !important;
    }

    .stat-card.patients { border-left-color: #28a745; }
    .stat-card.appointments { border-left-color: #007bff; }
    .stat-card.today { border-left-color: #ffc107; }
    .stat-card.pending { border-left-color: #dc3545; }

    .action-btn {
      background: linear-gradient(45deg, #667eea, #764ba2);
      border: none;
      border-radius: 15px;
      padding: 1rem 1.5rem;
      color: white;
      font-weight: 600;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      transition: all 0.3s ease;
      margin: 0.5rem;
    }
    
    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      color: white;
    }

    .action-btn i {
      margin-right: 0.5rem;
      font-size: 1.2rem;
    }
    
    .quick-search {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      margin-bottom: 2rem;
    }
    
    .table-container {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      margin-top: 2rem;
    }
    
    .title-section {
      text-align: center;
      margin-bottom: 2rem;
    }

    .title-section h1 {
      color: #2c3e50;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .title-section p {
      color: #6c757d;
      font-size: 1.1rem;
    }
    
    .btn-custom {
      border-radius: 10px;
      padding: 0.5rem 1rem;
      font-weight: 600;
      border: none;
      transition: all 0.3s ease;
    }
    
    .btn-custom:hover {
      transform: translateY(-1px);
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="dashboard-container">
      
      <!-- Header -->
      <div class="title-section">
        <h1><i class="bi bi-clipboard2-data"></i> Panel de Secretar√≠a</h1>
        <p>Gesti√≥n completa de pacientes, turnos y agenda m√©dica</p>
      </div>
      
      <!-- Statistics Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="stat-card patients">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-1">Total Pacientes</h6>
                <h3 class="mb-0" id="total-pacientes">0</h3>
              </div>
              <i class="bi bi-people-fill fs-1 text-success opacity-50"></i>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="stat-card appointments">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-1">Turnos Totales</h6>
                <h3 class="mb-0" id="total-turnos">0</h3>
              </div>
              <i class="bi bi-calendar-check-fill fs-1 text-primary opacity-50"></i>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="stat-card today">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-1">Turnos Hoy</h6>
                <h3 class="mb-0" id="turnos-hoy">0</h3>
              </div>
              <i class="bi bi-calendar-day-fill fs-1 text-warning opacity-50"></i>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="stat-card pending">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-1">Pendientes</h6>
                <h3 class="mb-0" id="turnos-pendientes">0</h3>
              </div>
              <i class="bi bi-clock-fill fs-1 text-danger opacity-50"></i>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Finance Statistics -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="stat-card" style="border-left-color: #28a745;">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-1">Ingresos del D√≠a</h6>
                <h3 class="mb-0" id="total-dia">$0</h3>
              </div>
              <i class="bi bi-cash-coin fs-1 text-success opacity-50"></i>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card" style="border-left-color: #007bff; cursor: pointer;" onclick="mostrarIngresosMes()" title="Click para ver desglose completo">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-1">Ingresos del Mes</h6>
                <h3 class="mb-0" id="total-mes">$0</h3>
                <small class="text-muted"><i class="bi bi-hand-index"></i> Click para desglose</small>
              </div>
              <i class="bi bi-calendar-month fs-1 text-primary opacity-50"></i>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card" style="border-left-color: #ffc107;">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-1">Pendientes Cobro</h6>
                <h3 class="mb-0" id="pendientes-cobro">0</h3>
              </div>
              <i class="bi bi-clock-history fs-1 text-warning opacity-50"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="text-center">
            <a href="/pacientes" class="action-btn">
              <i class="bi bi-person-plus"></i> Registrar Pacientes
            </a>
            <a href="/turnos" class="action-btn">
              <i class="bi bi-clipboard2-check"></i> Gestionar Turnos
            </a>
            <a href="/agenda" class="action-btn">
              <i class="bi bi-calendar-week"></i> Administrar Agenda
            </a>
            <button class="action-btn" onclick="mostrarBusquedaAvanzada()">
              <i class="bi bi-search"></i> B√∫squeda Avanzada
            </button>
            <button class="action-btn" onclick="mostrarGestionPagos()">
              <i class="bi bi-cash-stack"></i> Gesti√≥n de Pagos
            </button>
            </button class="action-btn" onclick="mostrarIngresosMes()">
              <i class="bi bi-graph-up"></i> Ingresos del Mes
            </button>
          </div>
        </div>
      </div>

       <!-- Quick Search -->
      <div class="quick-search" id="busqueda-rapida">
        <h5 class="mb-3"><i class="bi bi-search"></i> B√∫squeda R√°pida</h5>
        <div class="row">
          <div class="col-md-4">
            <input type="text" id="buscar-paciente" class="form-control" placeholder="Buscar paciente por nombre o DNI">
          </div>
          <div class="col-md-4">
            <input type="date" id="buscar-fecha" class="form-control">
          </div>
          <div class="col-md-4">
            <div class="d-flex gap-2">
              <button class="btn btn-primary btn-custom" onclick="buscarPaciente()">
                <i class="bi bi-search"></i> Buscar
              </button>
              <button class="btn btn-secondary btn-custom" onclick="limpiarBusqueda()">
                <i class="bi bi-arrow-clockwise"></i> Limpiar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Advanced Search (Hidden by default) -->
      <div class="quick-search" id="busqueda-avanzada" style="display: none;">
        <h5 class="mb-3"><i class="bi bi-funnel"></i> B√∫squeda Avanzada</h5>
        <div class="row">
          <div class="col-md-3">
            <select id="filtro-medico" class="form-select">
              <option value="">Todos los m√©dicos</option>
            </select>
          </div>
          <div class="col-md-3">
            <select id="filtro-estado" class="form-select">
              <option value="">Todos los estados</option>
              <option value="sin atender">Sin atender</option>
              <option value="recepcionado">Recepcionado</option>
              <option value="sala de espera">Sala de espera</option>
              <option value="llamado">Llamado</option>
              <option value="atendido">Atendido</option>
              <option value="ausente">Ausente</option>
            </select>
          </div>
          <div class="col-md-3">
            <input type="text" id="filtro-obra-social" class="form-control" placeholder="Obra social">
          </div>
          <div class="col-md-3">
            <button class="btn btn-success btn-custom w-100" onclick="aplicarFiltrosAvanzados()">
              <i class="bi bi-funnel-fill"></i> Aplicar Filtros
            </button>
          </div>
        </div>
      </div>
      <!-- Monthly Revenue Section -->
      <div class="quick-search" id="ingresos-mes" style="display: none;">
        <h5 class="mb-3"><i class="bi bi-graph-up"></i> Reporte de Ingresos Mensuales</h5>
        
      <!-- Month Selector -->
      <div class="row mb-3">
        <div class="col-md-4">
          <input type="month" id="mes-selector" class="form-control" onchange="cargarIngresosMes()">
          <small class="text-muted">Seleccione mes y a√±o</small>
        </div>
        <div class="col-md-8">
          <div class="d-flex gap-2">
            <button class="btn btn-primary btn-custom" onclick="cargarIngresosMes()">
              <i class="bi bi-arrow-clockwise"></i> Actualizar
            </button>
            <button class="btn btn-success btn-custom" onclick="exportarIngresosMesCSV()">
              <i class="bi bi-download"></i> Exportar CSV
            </button>
            <button class="btn btn-info btn-custom" onclick="mesActual()">
              <i class="bi bi-calendar-today"></i> Mes Actual
            </button>
          </div>
        </div>
      </div>
        
      <!-- Monthly Summary -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="stat-card" style="border-left-color: #28a745;">
            <div class="text-center">
              <h6 class="text-muted mb-1">Total del Mes</h6>
              <h3 class="mb-0 text-success" id="total-mes-detalle">$0</h3>
            </div>
          </div>
        </div>

      <div class="col-md-3">
          <div class="stat-card" style="border-left-color: #007bff;">
            <div class="text-center">
              <h6 class="text-muted mb-1">Pagos Particulares</h6>
              <h3 class="mb-0 text-primary" id="pagos-particulares">0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card" style="border-left-color: #17a2b8;">
            <div class="text-center">
              <h6 class="text-muted mb-1">Obra Social</h6>
              <h3 class="mb-0 text-info" id="pagos-obra-social">0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card" style="border-left-color: #6f42c1;">
            <div class="text-center">
              <h6 class="text-muted mb-1">Total Consultas</h6>
              <h3 class="mb-0 text-purple" id="total-consultas-mes">0</h3>
            </div>
          </div>
        </div>
      </div>

      <!-- Daily Breakdown -->
      <div class="table-container">
        <h6 class="mb-3"><i class="bi bi-calendar-range"></i> Desglose Diario del Mes</h6>
        <div class="table-responsive">
          <table class="table table-sm table-hover">
            <thead class="table-light">
              <tr>
                <th>Fecha</th>
                <th>D√≠a</th>
                <th>Cantidad</th>
                <th>Ingresos</th>
                <th>Ver Detalle</th>
              </tr>
            </thead>
            <tbody id="tabla-ingresos-diarios">
              <!-- Se cargan din√°micamente -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Daily Detail Modal -->
      <div class="table-container mt-3" id="detalle-dia" style="display: none;">
        <h6 class="mb-2" id="titulo-detalle-dia">Detalle del D√≠a</h6>
        <button class="btn btn-sm btn-secondary mb-2" onclick="cerrarDetalleDia()">
          <i class="bi bi-x"></i> Cerrar
        </button>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead class="table-light">
              <tr>
                <th>Paciente</th>
                <th>Monto</th>
                <th>Obra Social</th>
              </tr>
            </thead>
            <tbody id="tabla-detalle-dia">
              <!-- Se cargan din√°micamente -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Payment Management Section -->
    <div class="quick-search" id="gestion-pagos" style="display: none;">
      <h5 class="mb-3"><i class="bi bi-cash-stack"></i> Gesti√≥n de Pagos</h5>
        
      <!-- Payment Statistics and Export -->
        <div class="row mb-3">
          <div class="col-md-6">
            <input type="date" id="fecha-pagos" class="form-control" value="" onchange="actualizarGestionPagos()">
            <small class="text-muted">Seleccione fecha para ver pagos y recepcionados</small>
          </div>
          <div class="col-md-6">
          <div class="d-flex gap-2">
              <button class="btn btn-primary btn-custom" onclick="actualizarGestionPagos()">
                <i class="bi bi-arrow-clockwise"></i> Actualizar
              </button>
              <button class="btn btn-info btn-custom" onclick="exportarPagosCSV()">
                <i class="bi bi-download"></i> Exportar CSV
              </button>
            </div>
          </div>
        </div> 
        
              <!-- Patients waiting for payment -->
        <div id="pacientes-cobrar">
          <h6 class="mb-2"><i class="bi bi-people-fill"></i> Pacientes Recepcionados - Pendientes de Cobro</h6>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead class="table-light">
                <tr>
                  <th>Hora</th>
                  <th>Apellido</th>
                  <th>Nombre</th>
                  <th>DNI</th>
                  <th>Obra Social</th>
                  <th>M√©dico</th>
                  <th>Monto</th>
                  <th>Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="tabla-pacientes-cobrar">
                <!-- Se cargan din√°micamente -->
              </tbody>
            </table>
          </div>
        </div>
         
        <!-- Information Panel -->
        <div id="info-flujo-pago" class="alert alert-info mt-3">
          <h6 class="mb-2"><i class="bi bi-info-circle"></i> Flujo de Pagos</h6>
          <p class="mb-1"><strong>1. Recepcionar:</strong> Cuando llega el paciente (Gesti√≥n de Turnos)</p>
          <p class="mb-1"><strong>2. Cobrar:</strong> Desde aqu√≠ o desde Gesti√≥n de Turnos</p>
          <p class="mb-0"><strong>3. M√©dico:</strong> Llamar desde sala de espera ‚Üí atender</p>
        </div>
        <!-- Payment History -->
        <div id="historial-pagos">
          <h6 class="mb-2">Pagos Registrados Hoy</h6>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead class="table-light">
                <tr>
                  <th>Apellido</th>
                  <th>Nombre</th>
                  <th>DNI</th>
                  <th>Monto</th>
                  <th>Obra Social</th>
                  <th>Observaciones</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="tabla-pagos-hoy">
              </tbody>
            </table>
          </div>
        </div>
      </div>

        <!-- Results Table -->
      <div class="table-container" id="tabla-resultados">
        <h5 class="mb-3"><i class="bi bi-table"></i> Turnos de Hoy</h5>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Hora</th>
                <th>Paciente</th>
                <th>DNI</th>
                <th>M√©dico</th>
                <th>Estado</th>
                <th>Obra Social</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla-turnos-body">
              <!-- Datos se cargan din√°micamente -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Back Button -->
      <div class="text-center mt-4">
        <a href="/" class="btn btn-outline-secondary btn-lg">
          <i class="bi bi-arrow-left"></i> Volver al Panel Principal
        </a>
      </div>
      
    </div>

<!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    let pacientes = [];
    let turnos = [];
    let medicos = [];
    let pagos = [];
    let estadisticasPagos = {};
    
    // Cargar datos iniciales
    async function cargarDatos() {
      try {
        // Cargar pacientes
        const resPacientes = await fetch('/api/pacientes');
        pacientes = await resPacientes.json();
        
        // Cargar turnos
        const resTurnos = await fetch('/api/turnos');
        turnos = await resTurnos.json();
        
        // Cargar pagos
        const resPagos = await fetch('/api/pagos');
        pagos = await resPagos.json();
        
        // Cargar estad√≠sticas de pagos del mes actual
        const fechaHoy = new Date();
        const mesActual = `${fechaHoy.getFullYear()}-${String(fechaHoy.getMonth() + 1).padStart(2, '0')}`;
        const resEstadisticas = await fetch(`/api/pagos/estadisticas?mes=${mesActual}`);
        estadisticasPagos = await resEstadisticas.json();

        // Extraer m√©dicos √∫nicos
        medicos = [...new Set(turnos.map(t => t.medico))];
        
        // Actualizar estad√≠sticas
        await actualizarEstadisticas();
        
        // Cargar tabla de turnos de hoy
        await cargarTurnosHoy();
        
        // Configurar fechas a hoy
        const fechaActual = new Date().toISOString().split('T')[0];
        document.getElementById('fecha-pagos').value = fechaActual;
        document.getElementById('buscar-fecha').value = fechaActual;
        
        // Configurar fecha de pagos a hoy
        document.getElementById('fecha-pagos').value = new Date().toISOString().split('T')[0];
        
      } catch (error) {
        console.error('Error cargando datos:', error);
      }
    }
     
    async function actualizarEstadisticas() {
      const hoy = new Date().toISOString().split('T')[0];
      const turnosHoy = turnos.filter(t => t.fecha === hoy);
      const turnosPendientes = turnos.filter(t => ['sin atender', 'llamado'].includes(t.estado));
      
      // Obtener pacientes recepcionados pendientes de cobro
      let pacientesRecepcionados = 0;
      try {
        const response = await fetch(`/api/pacientes/recepcionados?fecha=${hoy}`);
        const recepcionados = await response.json();
        pacientesRecepcionados = recepcionados.length;
      } catch (error) {
        console.error('Error obteniendo recepcionados:', error);
      }
      document.getElementById('total-pacientes').textContent = pacientes.length;
      document.getElementById('total-turnos').textContent = turnos.length;
      document.getElementById('turnos-hoy').textContent = turnosHoy.length;
      document.getElementById('turnos-pendientes').textContent = turnosPendientes.length;
      document.getElementById('pendientes-cobro').textContent = pacientesRecepcionados;
      
    
     
      // Actualizar estad√≠sticas de pagos
      document.getElementById('total-dia').textContent = `$${estadisticasPagos.total_dia || 0}`;
      document.getElementById('total-mes').textContent = `$${estadisticasPagos.total_mes || 0}`;
    }
    
    async function cargarTurnosHoy() {
      const hoy = new Date().toISOString().split('T')[0];
      try {
         // Usar la API espec√≠fica para turnos del d√≠a que incluye informaci√≥n del paciente
        const response = await fetch(`/api/turnos/dia?fecha=${hoy}`);
        const turnosHoy = await response.json();
        mostrarTurnosEnTabla(turnosHoy);
       } catch (error) {
        console.error('Error cargando turnos de hoy:', error);
        // Fallback: usar datos ya cargados
        const turnosHoy = turnos.filter(t => t.fecha === hoy);
        mostrarTurnosEnTabla(turnosHoy);
      }
    }
    
    function mostrarTurnosEnTabla(turnosMostrar) {
      const tbody = document.getElementById('tabla-turnos-body');
      tbody.innerHTML = '';
      
      if (turnosMostrar.length === 0) {
        body.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No hay turnos para mostrar hoy</td></tr>';
        return;
      }
      // Ordenar por hora
      turnosMostrar.sort((a, b) => (a.hora || '00:00').localeCompare(b.hora || '00:00'));
       
      turnosMostrar.forEach(turno => {
        // Usar paciente enriquecido de la API o buscar en el array local
        const paciente = turno.paciente || pacientes.find(p => p.dni === turno.dni_paciente) || {};
         
        // Colores para todos los estados
        const estadoColor = {
          'sin atender': 'secondary',
          'recepcionado': 'success',
          'sala de espera': 'primary',
          'llamado': 'warning',
          'atendido': 'success',
          'ausente': 'danger'
        }[turno.estado] || 'secondary';

        // Iconos para cada estado
        const estadoIcon = {
          'sin atender': '‚è≥',
          'recepcionado': '‚úÖ',
          'sala de espera': 'üè•',
          'llamado': 'üìû',
          'atendido': '‚úîÔ∏è',
          'ausente': '‚ùå'
        }[turno.estado] || '‚è≥';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${turno.hora}</strong></td>
          <td>${paciente.nombre || ''} ${paciente.apellido || ''}</td>
          <td>${turno.dni_paciente}</td>
          <td>${turno.medico}</td>
          <td><span class="badge bg-${estadoColor}">${estadoIcon} ${turno.estado}</span></td>
          <td>${paciente.obra_social || '-'}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="editarTurno('${turno.dni_paciente}', '${turno.fecha}', '${turno.hora}')">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-outline-danger" onclick="eliminarTurno('${turno.dni_paciente}', '${turno.fecha}', '${turno.hora}')">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function cargarOpcionesMedicos() {
      const select = document.getElementById('filtro-medico');
      medicos.forEach(medico => {
        const option = document.createElement('option');
        option.value = medico;
        option.textContent = medico;
        select.appendChild(option);
      });
    }
    
    function mostrarBusquedaAvanzada() {
      const busquedaAvanzada = document.getElementById('busqueda-avanzada');
      busquedaAvanzada.style.display = busquedaAvanzada.style.display === 'none' ? 'block' : 'none';
    }
    
    async function buscarPaciente() {
      const texto = document.getElementById('buscar-paciente').value.toLowerCase();
      const fecha = document.getElementById('buscar-fecha').value || new Date().toISOString().split('T')[0];
      
      try {
         // Obtener turnos de la fecha espec√≠fica
        const response = await fetch(`/api/turnos/dia?fecha=${fecha}`);
        let turnosFiltrados = await response.json();
         
        // Aplicar filtro de texto si existe
        if (texto) {
          turnosFiltrados = turnosFiltrados.filter(turno => {
            const paciente = turno.paciente || {};
            return turno.dni_paciente.includes(texto) ||
                  (paciente.nombre && paciente.nombre.toLowerCase().includes(texto)) ||
                  (paciente.apellido && paciente.apellido.toLowerCase().includes(texto));
          });
        }
         
        mostrarTurnosEnTabla(turnosFiltrados);
      } catch (error) {
        console.error('Error buscando pacientes:', error);
        alert('Error al buscar pacientes');
      }
    }
    
    async function limpiarBusqueda() {
      document.getElementById('buscar-paciente').value = '';
      document.getElementById('buscar-fecha').value = '';
      await cargarTurnosHoy();
    }
    
    async function aplicarFiltrosAvanzados() {
      const medico = document.getElementById('filtro-medico').value;
      const estado = document.getElementById('filtro-estado').value;
      const obraSocial = document.getElementById('filtro-obra-social').value.toLowerCase();
      const fecha = document.getElementById('buscar-fecha').value || new Date().toISOString().split('T')[0];

      try {
        // Obtener turnos m√°s recientes de la fecha
        const response = await fetch(`/api/turnos/dia?fecha=${fecha}`);
        let turnosFiltrados = await response.json();
         
        if (medico) {
          turnosFiltrados = turnosFiltrados.filter(t => t.medico === medico);
        }
         
        if (estado) {
          turnosFiltrados = turnosFiltrados.filter(t => t.estado === estado);
        }
         
        if (obraSocial) {
          turnosFiltrados = turnosFiltrados.filter(turno => {
            const paciente = turno.paciente || {};
            return paciente.obra_social && paciente.obra_social.toLowerCase().includes(obraSocial);
          });
        }
         
        mostrarTurnosEnTabla(turnosFiltrados);
      } catch (error) {
        console.error('Error aplicando filtros:', error);
        alert('Error al aplicar filtros');
      }
    }

    async function editarTurno(dni, fecha, hora) {
      const nuevaHora = prompt('Ingrese la nueva hora (HH:MM):', hora);
      const nuevaFecha = prompt('Ingrese la nueva fecha (YYYY-MM-DD):', fecha);
      
      if ((nuevaHora && nuevaHora !== hora) || (nuevaFecha && nuevaFecha !== fecha)) {
        try {
          const data = {};
          if (nuevaHora && nuevaHora !== hora) data.nueva_hora = nuevaHora;
          if (nuevaFecha && nuevaFecha !== fecha) data.nueva_fecha = nuevaFecha;
          
          const response = await fetch(`/api/turnos/${dni}/${fecha}/${hora}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
          });
          
          const result = await response.json();
          
          if (response.ok) {
            alert('Turno actualizado correctamente');
            await cargarDatos(); // Recargar los datos
          } else {
            alert('Error: ' + result.error);
          }
        } catch (error) {
          alert('Error al actualizar el turno: ' + error.message);
        }
      }
    }

    async function eliminarTurno(dni, fecha, hora) {
      if (confirm('¬øEst√° seguro de que desea eliminar este turno?')) {
        try {
          const response = await fetch(`/api/turnos/${dni}/${fecha}/${hora}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
            }
          });
          
          const result = await response.json();
          
          if (response.ok) {
            alert('Turno eliminado correctamente');
            await cargarDatos(); // Recargar los datos
          } else {
            alert('Error: ' + result.error);
          }
        } catch (error) {
          alert('Error al eliminar el turno: ' + error.message);
        }
      }
    }

    // === FUNCIONES DE PAGOS ===
    
    function mostrarGestionPagos() {
      const gestionPagos = document.getElementById('gestion-pagos');
      gestionPagos.style.display = gestionPagos.style.display === 'none' ? 'block' : 'none';
      
      if (gestionPagos.style.display === 'block') {
        cargarPacientesRecepcionados();
        cargarPagosHoy();
      }
    }
    
    function actualizarGestionPagos() {
      cargarPacientesRecepcionados();
      cargarPagosHoy();
    }

    // === FUNCIONES DE INGRESOS MENSUALES ===
    
    function mostrarIngresosMes() {
      const ingresosMes = document.getElementById('ingresos-mes');
      ingresosMes.style.display = ingresosMes.style.display === 'none' ? 'block' : 'none';
      
      if (ingresosMes.style.display === 'block') {
        // Configurar mes actual por defecto
        const hoy = new Date();
        const mesActual = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}`;
        document.getElementById('mes-selector').value = mesActual;
        cargarIngresosMes();
      }
    }
    
    function mesActual() {
      const hoy = new Date();
      const mesActual = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}`;
      document.getElementById('mes-selector').value = mesActual;
      cargarIngresosMes();
    }

    async function cargarIngresosMes() {
      const mesSeleccionado = document.getElementById('mes-selector').value;
      if (!mesSeleccionado) {
        alert('Por favor seleccione un mes');
        return;
      }
      
      try {
        const response = await fetch(`/api/pagos/estadisticas?mes=${mesSeleccionado}`);
        const estadisticas = await response.json();
        
        // Actualizar estad√≠sticas principales
        document.getElementById('total-mes-detalle').textContent = `$${estadisticas.total_mes}`;
        document.getElementById('pagos-particulares').textContent = estadisticas.pagos_particulares;
        document.getElementById('pagos-obra-social').textContent = estadisticas.pagos_obra_social;
        document.getElementById('total-consultas-mes').textContent = estadisticas.cantidad_pagos_mes;
        
        // Cargar tabla de ingresos diarios
        cargarTablaIngresosDiarios(estadisticas.detalle_por_dia);
        
      } catch (error) {
        console.error('Error cargando ingresos del mes:', error);
        alert('Error al cargar los ingresos del mes');
      }
    }

    function cargarTablaIngresosDiarios(detallePorDia) {
      const tbody = document.getElementById('tabla-ingresos-diarios');
      tbody.innerHTML = '';
      
      if (Object.keys(detallePorDia).length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay ingresos registrados para este mes</td></tr>';
        return;
      }
      
      Object.entries(detallePorDia).forEach(([fecha, datos]) => {
        const fechaObj = new Date(fecha + 'T00:00:00');
        const nombreDia = fechaObj.toLocaleDateString('es-ES', { weekday: 'long' });
        const fechaFormateada = fechaObj.toLocaleDateString('es-ES');
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${fechaFormateada}</strong></td>
          <td class="text-capitalize">${nombreDia}</td>
          <td><span class="badge bg-primary">${datos.cantidad}</span></td>
          <td><strong class="text-success">$${datos.monto}</strong></td>
          <td>
            <button class="btn btn-sm btn-outline-info" onclick="mostrarDetalleDia('${fecha}', '${fechaFormateada}')">
              <i class="bi bi-eye"></i> Ver
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function mostrarDetalleDia(fecha, fechaFormateada) {
      // Buscar los datos del d√≠a en las estad√≠sticas cargadas
      fetch(`/api/pagos/estadisticas?mes=${fecha.substring(0, 7)}`)
        .then(response => response.json())
        .then(estadisticas => {
          const datosDia = estadisticas.detalle_por_dia[fecha];
          if (!datosDia) {
            alert('No hay datos para esta fecha');
            return;
          }
          
          document.getElementById('titulo-detalle-dia').textContent = `Detalle del ${fechaFormateada}`;
          
          const tbody = document.getElementById('tabla-detalle-dia');
          tbody.innerHTML = '';
          
          datosDia.pacientes.forEach(paciente => {
            const row = document.createElement('tr');
            const montoTexto = paciente.monto === 0 ? 'Obra Social' : `$${paciente.monto}`;
            const montoColor = paciente.monto === 0 ? 'text-info' : 'text-success';
            
            row.innerHTML = `
              <td>${paciente.nombre}</td>
              <td class="${montoColor}"><strong>${montoTexto}</strong></td>
              <td>${paciente.obra_social || '-'}</td>
            `;
            tbody.appendChild(row);
          });
          
          document.getElementById('detalle-dia').style.display = 'block';
          document.getElementById('detalle-dia').scrollIntoView({ behavior: 'smooth' });
        })
        .catch(error => {
          console.error('Error cargando detalle del d√≠a:', error);
          alert('Error al cargar el detalle del d√≠a');
        });

    }
    
    function cerrarDetalleDia() {
      document.getElementById('detalle-dia').style.display = 'none';
    }
    
    async function exportarIngresosMesCSV() {
      const mesSeleccionado = document.getElementById('mes-selector').value;
      if (!mesSeleccionado) {
        alert('Por favor seleccione un mes');
        return;
      }
      
      try {
        const response = await fetch(`/api/pagos/estadisticas?mes=${mesSeleccionado}`);
        const estadisticas = await response.json();
        
        // Crear CSV
        let csv = 'Fecha,D√≠a,Cantidad Consultas,Ingresos,Pacientes\n';
        
        Object.entries(estadisticas.detalle_por_dia).forEach(([fecha, datos]) => {
          const fechaObj = new Date(fecha + 'T00:00:00');
          const nombreDia = fechaObj.toLocaleDateString('es-ES', { weekday: 'long' });
          const fechaFormateada = fechaObj.toLocaleDateString('es-ES');
          const pacientesList = datos.pacientes.map(p => `${p.nombre} ($${p.monto})`).join('; ');
          
          csv += `"${fechaFormateada}","${nombreDia}",${datos.cantidad},$${datos.monto},"${pacientesList}"\n`;
        });
        
        // Agregar resumen
        csv += '\n';
        csv += 'RESUMEN DEL MES\n';
        csv += `Total del Mes,$${estadisticas.total_mes}\n`;
        csv += `Pagos Particulares,${estadisticas.pagos_particulares}\n`;
        csv += `Obra Social,${estadisticas.pagos_obra_social}\n`;
        csv += `Total Consultas,${estadisticas.cantidad_pagos_mes}\n`;
        
        // Descargar archivo
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `ingresos_${mesSeleccionado}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert('Reporte de ingresos descargado correctamente');
        
      } catch (error) {
        console.error('Error exportando ingresos:', error);
        alert('Error al exportar el reporte de ingresos');
      }
    }

    
    async function cargarPagosHoy() {
      const fecha = document.getElementById('fecha-pagos').value || new Date().toISOString().split('T')[0];
      const pagosHoy = pagos.filter(p => p.fecha === fecha);
      
      const tbody = document.getElementById('tabla-pagos-hoy');
      tbody.innerHTML = '';
      
      if (pagosHoy.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No hay pagos registrados para esta fecha</td></tr>';
        return;
      }

      pagosHoy.forEach(pago => {
        const row = document.createElement('tr');
        const paciente = pacientes.find(p => p.dni === pago.dni_paciente) || {};
        
        // Determinar color del monto seg√∫n si es gratis o pagado
        const montoColor = pago.monto == 0 ? 'text-success' : 'text-primary';
        const montoTexto = pago.monto == 0 ? 'Obra Social' : `$${pago.monto}`;
         
        row.innerHTML = `
          <td>${paciente.apellido || ''}</td>
          <td>${paciente.nombre || ''}</td>
          <td>${pago.dni_paciente}</td>
          <td class="${montoColor}"><strong>${montoTexto}</strong></td>
          <td>${pago.obra_social || '-'}</td>
          <td>${pago.observaciones || '-'}</td>
          <td>
            <button class="btn btn-sm btn-outline-danger" onclick="eliminarPago(${pago.id}, '${pago.nombre_paciente}')">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }
    
    async function cargarPacientesRecepcionados() {
      const fecha = document.getElementById('fecha-pagos').value || new Date().toISOString().split('T')[0];
      
      try {
        const response = await fetch(`/api/pacientes/recepcionados?fecha=${fecha}`);
        const pacientesRecepcionados = await response.json();
        
        const tbody = document.getElementById('tabla-pacientes-cobrar');
        tbody.innerHTML = '';
        
        if (pacientesRecepcionados.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No hay pacientes recepcionados pendientes de cobro</td></tr>';
          return;
        }
        
        pacientesRecepcionados.forEach(paciente => {
          const row = document.createElement('tr');
          row.className = 'table-warning'; // Resaltar que est√°n pendientes
          
          row.innerHTML = `
            <td><strong>${paciente.hora_turno}</strong></td>
            <td>${paciente.apellido}</td>
            <td>${paciente.nombre}</td>
            <td>${paciente.dni}</td>
            <td>${paciente.obra_social || '-'}</td>
            <td>${paciente.medico}</td>
            <td>
              <input type="number" class="form-control form-control-sm" 
                     id="monto-${paciente.dni}" placeholder="0.00" step="0.01" min="0" 
                     style="width: 80px;">
            </td>
            <td>
              <button class="btn btn-sm btn-success"
                     onclick="cobrarPacienteRecepcionado('${paciente.dni}', '${fecha}')">
                <i class="bi bi-cash-coin"></i> Cobrar
              </button>
              </td>
          `;
          tbody.appendChild(row);
        });
        
      } catch (error) {
        console.error('Error cargando pacientes recepcionados:', error);
      }
    }

    async function cobrarPacienteRecepcionado(dni, fecha) {
      const montoInput = document.getElementById(`monto-${dni}`);
      const monto = parseFloat(montoInput.value || 0);
      
      if (isNaN(monto) || monto < 0) {
        alert('Por favor ingrese un monto v√°lido (puede ser 0 para obra social)');
        return;
      }
      
      const observaciones = prompt('Observaciones (opcional):', '') || '';
      
      try {
        const response = await fetch('/api/pagos/cobrar-y-sala', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            dni_paciente: dni,
            fecha: fecha,
            monto: monto,
            observaciones: observaciones
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          if (monto > 0) {
            alert(`‚úÖ Pago de $${monto} registrado correctamente\nüè• Paciente movido a sala de espera`);
          } else {
            alert(`‚úÖ Consulta cubierta por obra social\nüè• Paciente movido a sala de espera`);
          }
          
                               // Recargar datos
          await cargarDatos();
          await cargarTurnosHoy(); // Actualizar tabla de turnos
          cargarPacientesRecepcionados();
          cargarPagosHoy();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error al cobrar: ' + error.message);
      }
    }
    
    async function eliminarPago(pagoId, nombrePaciente) {
      if (confirm(`¬øEst√° seguro de que desea eliminar el pago de ${nombrePaciente}?`)) {
        try {
          const response = await fetch(`/api/pagos/${pagoId}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
            }
          });
          
          const result = await response.json();
          
          if (response.ok) {
            alert('Pago eliminado correctamente');
            await cargarDatos(); // Recargar estad√≠sticas
            cargarPacientesRecepcionados(); // Recargar recepcionados
            cargarPagosHoy(); // Actualizar tabla
          } else {
            alert('Error: ' + result.error);
          }
        } catch (error) {
          alert('Error al eliminar pago: ' + error.message);
        }
      }
    }
    

    async function exportarPagosCSV() {
      try {
        const response = await fetch('/api/pagos/exportar');
        
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = `pagos_${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          
          alert('Archivo CSV descargado correctamente');
        } else {
          alert('Error al exportar archivo CSV');
        }
      } catch (error) {
        alert('Error al exportar CSV: ' + error.message);
      }
    }
    
    // Cargar datos al iniciar la p√°gina
    document.addEventListener('DOMContentLoaded', cargarDatos);
  </script>
</body>
</html>
