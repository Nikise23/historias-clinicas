<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Historia Clínica</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 font-sans">
  <div class="max-w-4xl mx-auto bg-white shadow-md rounded-xl p-6">
    <h1 class="text-2xl font-bold mb-4">Historia Clínica del Paciente</h1>


    <form id="formHistoria" class="space-y-4">
      <input type="hidden" id="dni" name="dni" value="{{ dni }}">


      <div>
        <label class="block font-medium">Nombre:</label>
        <input type="text" id="nombre" name="nombre" class="border w-full p-2 rounded" required>
      </div>


      <div>
        <label class="block font-medium">Apellido:</label>
        <input type="text" id="apellido" name="apellido" class="border w-full p-2 rounded" required>
      </div>


      <div>
        <label class="block font-medium">Fecha de nacimiento:</label>
        <input type="date" id="fecha_nacimiento" name="fecha_nacimiento" class="border w-full p-2 rounded">
      </div>


      <div>
        <label class="block font-medium">Obra social:</label>
        <input type="text" id="obra_social" name="obra_social" class="border w-full p-2 rounded">
      </div>


      <div>
        <label class="block font-medium">Número de obra social:</label>
        <input type="text" id="numero_obra_social" name="numero_obra_social" class="border w-full p-2 rounded">
      </div>


      <div>
        <label class="block font-medium">Diagnóstico:</label>
        <textarea id="diagnostico" name="diagnostico" class="border w-full p-2 rounded" required></textarea>
      </div>


      <div>
        <label class="block font-medium">Tratamiento:</label>
        <textarea id="tratamiento" name="tratamiento" class="border w-full p-2 rounded"></textarea>
      </div>


      <div>
        <label class="block font-medium">Observaciones:</label>
        <textarea id="observaciones" name="observaciones" class="border w-full p-2 rounded"></textarea>
      </div>


      <div>
        <label class="block font-medium">Fecha de atención:</label>
        <input type="date" id="fecha_consulta" name="fecha_consulta" class="border w-full p-2 rounded">
      </div>


      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Guardar Historia</button>
    </form>


    <div class="mt-6">
      <a href="/turnos" class="text-blue-600 hover:underline text-sm">← Volver a Turnos</a>
    </div>


    <hr class="my-6">


    <div id="historiasPrevias" class="space-y-4">
      <h2 class="text-xl font-semibold mb-2">Entradas Anteriores</h2>
      <!-- Las entradas se cargarán con JavaScript -->
    </div>
  </div>


  <script>
    const dni = "{{ dni }}";
    const form = document.getElementById("formHistoria");
    const contenedorHistorias = document.getElementById("historiasPrevias");


    // Cargar todas las historias y filtrar por DNI
    fetch("/api/historias")
      .then(res => res.json())
      .then(data => {
        const historias = data.filter(h => h.dni === dni);
        if (historias.length === 0) {
          contenedorHistorias.innerHTML += "<p class='text-gray-600'>No hay entradas anteriores.</p>";
          return;
        }


        historias.forEach(h => {
          const div = document.createElement("div");
          div.className = "border p-4 rounded bg-gray-50";
          div.innerHTML = `
            <p><strong>Fecha de atención:</strong> ${h.fecha_consulta || "No especificada"}</p>
            <p><strong>Diagnóstico:</strong> ${h.diagnostico}</p>
            <p><strong>Tratamiento:</strong> ${h.tratamiento || "Sin tratamiento"}</p>
            <p><strong>Observaciones:</strong> ${h.observaciones || "Sin observaciones"}</p>
            <p><strong>Médico:</strong> ${h.medico || "Desconocido"}</p>
          `;
          contenedorHistorias.appendChild(div);
        });
      });


    // Manejar envío del formulario
    form.addEventListener("submit", async e => {
      e.preventDefault();


      const datos = {
        nombre: form.nombre.value,
        apellido: form.apellido.value,
        dni: form.dni.value,
        fecha_nacimiento: form.fecha_nacimiento.value,
        obra_social: form.obra_social.value,
        numero_obra_social: form.numero_obra_social.value,
        diagnostico: form.diagnostico.value,
        tratamiento: form.tratamiento.value,
        observaciones: form.observaciones.value,
        fecha_consulta: form.fecha_consulta.value,
      };


      // Agregar médico actual desde sesión
      const sesion = await fetch("/api/session-info").then(r => r.json());
      datos.medico = sesion.usuario;


      const res = await fetch("/historias", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos)
      });


      const resultado = await res.json();


      if (res.ok) {
        alert("Historia guardada correctamente.");
        location.reload();
      } else {
        alert("Error: " + resultado.error);
      }
    });
  </script>
</body>
</html>
